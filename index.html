<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MARD 豆库 -拼豆库存管理工具</title>
    <style>
        :root { --primary: #4a90e2; --warn: #ff4d4f; --bg: #f0f2f5; --success: #52c41a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; font-size: 14px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; padding-bottom: 90px; }
        


        /* 头部控制区 */
        .header-sticky { position: sticky; top: 0; background: white; z-index: 100; border-bottom: 2px solid #eee; padding: 12px 15px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stats { display: flex; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex: 1; margin-right: 10px; }
        .stat-item b { display: block; font-size: 16px; color: var(--primary); }

        /* 配置与排序区 */
        .config-zone { font-size: 12px; background: #fffbe6; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .config-zone input { width: 40px; padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .btn-sort { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-sort.active { background: var(--primary); color: white; }

        .btn-text { font-size: 12px; color: var(--primary); cursor: pointer; background:none; border:none; padding:0; text-decoration: underline; }

        /* 搜索框 */
        #search { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; margin-bottom: 5px; }
        
        /* 列表渲染 */
        .bead-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .bead-row.selected { background: #e6f7ff; }
        .col-select { width: 25px; }
        .col-color { width: 40px; }
        .swatch { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; }
        .col-id { width: 60px; font-weight: bold; font-family: monospace; font-size: 15px; }
        .col-weight { flex: 1; }
        .weight-badge { padding: 4px 8px; border-radius: 6px; background: #eee; font-weight: bold; font-family: monospace; cursor: pointer; }
        .weight-badge.low { background: var(--warn); color: white; }
        .col-action { width: 60px; text-align: right; }
        .btn-plus { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; padding: 5px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; }
        .btn-detail { background: #fff; border: 1px solid #d9d9d9; color: #666; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; margin-left: 5px; transition: all 0.2s; }
        .btn-detail:hover { color: var(--primary); border-color: var(--primary); }

        .info-tag { font-size: 10px; color: #999; display: block; margin-top: 3px; }
        .total-use { color: #8c8c8c; font-weight: bold; }

        /* 底部操作栏 */
        .footer-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: #333; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 200; border-radius: 12px 12px 0 0; }
        .btn-go { background: var(--success); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* 弹窗样式升级 */
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index:1000; transition: opacity 0.3s; }
        .modal { 
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
            background:white; padding:24px; border-radius:24px; 
            width: 85%; max-width: 360px; max-height: 70vh; overflow-y: auto; 
            z-index:1010; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop {
            0% { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .modal h3 { margin: 0 0 8px 0; text-align: center; font-size: 18px; color: #1f2937; }
        .modal-desc { text-align: center; color: #6b7280; font-size: 13px; margin-bottom: 24px; }
        
        .input-group { position: relative; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; }
        .input-group input {
            width: 100%; padding: 16px; 
            border: 2px solid transparent; 
            background: #f3f4f6;
            border-radius: 16px; 
            font-size: 28px; text-align: center; font-weight: 700; color: #111827; 
            outline: none; transition: all 0.2s;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        .input-group input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
        .input-suffix { position: absolute; right: 20px; color: #9ca3af; font-weight: 600; font-size: 16px; pointer-events: none; }

        .modal-btn-group { display: flex; flex-direction: column; gap: 12px; }
        .m-btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
        }
        .m-btn:active { transform: scale(0.98); }
        .m-btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(74, 144, 226, 0.3); }
        .m-btn-ghost { background: #f3f4f6; color: #4b5563; }
        
        .modal-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .modal-row:last-child { border-bottom: none; }
        .modal-input { width: 70px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; background: #f9fafb; font-weight: 600; }
        

        /* 移动端适配优化 */
        @media (max-width: 480px) {
            .container { padding-bottom: 80px; }
            .bead-row { padding: 8px 5px; }
            
            .col-select { width: 18px; }
            .col-color { width: 26px; padding-left: 6px; box-sizing: content-box; }
            .swatch { width: 20px; height: 20px; }
            .col-id { width: 38px; font-size: 12px; }
            .col-action { width: 42px; }
            
            .weight-badge { font-size: 12px; padding: 2px 6px; }
            .btn-plus { padding: 4px 4px; font-size: 10px; }
            /* 恢复左对齐缩放，并给一个固定的左边距，预留出大概1000g数字的空间 */
            .btn-detail { padding: 0 4px; height: 18px; line-height: 16px; font-size: 12px; border-radius: 4px; margin-left: 2px; transform: scale(0.85); transform-origin: left center; white-space: nowrap; }
            
            /* 在小屏幕上减小间距 */
            .weight-primary-row { gap: 6px !important; }
            .weight-detail-row { gap: 4px !important; }
            .grain-info { display: none !important; } /* 极小屏幕隐藏粒数估算，或缩小 */
        }
        
        /* 中等屏幕显示粒数 */
        @media (min-width: 360px) and (max-width: 480px) {
            .grain-info { display: inline !important; font-size: 9px !important; }
        }

    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; padding:8px; color:#999; font-size:12px;">
        开发者: 小红书用户āōē，ID 11535779483，使用AI工具开发
    </div>
    <div class="header-sticky">
        <div class="top-bar">
            <div class="stats" style="align-items: flex-start; gap: 15px;">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:12px; color:#999; margin-bottom:2px;">色号</span>
                    <b style="font-size:14px; color:#333; line-height:1.2;">Mard 221</b>
                </div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:12px; color:#999; margin-bottom:2px;">补货</span>
                    <div style="display:flex; align-items:baseline; gap:5px;">
                        <b id="count-low" style="font-size:14px; color:var(--warn); line-height:1.2;">0</b>
                        <button class="btn-text" onclick="openLowStockModal()" style="font-size:12px; padding:0; text-decoration:underline; white-space:nowrap;">补货单</button>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:12px; color:#999; margin-bottom:2px;">阈值</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <input type="number" id="threshold" value="5" onchange="updateThreshold()" style="width:35px; border:none; border-bottom:1px solid #999; text-align:center; color:#333; font-size:14px; font-weight:bold; padding:0; background:transparent;">
                        <span style="font-size:12px; color:#333;">g</span>
                    </div>
                </div>
            </div>
                        <div style="display:flex; flex-direction:column; gap:5px; align-items: flex-end;">
                <button class="btn-text" onclick="showModal('helpModal')" style="font-size:12px; color:#4a90e2;">📖 使用说明</button>
                <button class="btn-text" onclick="openBatchInput()" style="font-size:12px; color:#4a90e2;">📊 初始录入</button>
                <button class="btn-text" onclick="openDataModal('backup')" style="font-size:12px; color:#4a90e2;">⚙️ 数据管理</button>
                <button class="btn-text" onclick="showDevInfo()" style="font-size:12px; color:#4a90e2;">🧑 作者账号</button>
            </div>
        </div>

        <input type="text" id="search" placeholder="输入色号搜索..." oninput="render()">
        
        <div style="display:flex; align-items:center; padding:0px 0px; font-size:12px; color:#999; margin-top:5px;">
            <div style="width:5px;"></div>
            <div style="flex:1; display:flex; align-items:center;">
                 <span style="margin-right:5px;">排序：</span>
                 <select id="sortSelect" onchange="changeSortMode()" style="font-size:12px; color:#333; border:1px solid #eee; background:transparent; outline:none; padding:2px; border-radius:4px; cursor:pointer;">
                    <option value="id">按色号排序</option>
                    <option value="stock_desc">库存由多到少</option>
                    <option value="stock_asc">库存由少到多</option>
                    <option value="usage_desc">消耗量由多到少</option>
                    <option value="usage_asc">消耗量由少到多</option>
                    <option value="restock_desc">补货量由多到少</option>
                    <option value="restock_asc">补货量由少到多</option>
                 </select>
            </div>
            <div style="width:60px;"></div>
        </div>
    </div>

    <div id="grid"></div>
    <div style="text-align:center; padding:10px; color:#999; font-size:10px;">
        开发者: 小红书用户āōē，ID 11535779483，使用AI工具开发
    </div>
</div>

    <div id="footer" class="footer-bar" style="display:none;">
        <div style="font-size:14px; display:flex; align-items:center; gap:10px;">
            <span>已选 <b id="selNum" style="color:#ffd700; font-size:18px;">0</b> 色</span>
            <button onclick="cancelSelection()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; padding:4px 10px; border-radius:15px; font-size:12px; cursor:pointer;">取消</button>
        </div>
        <button class="btn-go" onclick="openConsumeModal()">录入粒数</button>
    </div>

    <!-- 弹窗部分 -->

<div class="overlay" id="mask" onclick="closeAllModals()"></div>
<div id="consumeModal" class="modal" style="width: 85%; max-width: 340px; padding: 20px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">消耗录入 (粒数)</h3>
    <div id="modalList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 5px;"></div>
    <div class="modal-btn-group" style="gap: 10px;">
        <button class="m-btn m-btn-primary" onclick="submitConsume()" style="padding: 10px; font-size: 14px; border-radius: 10px;">确认扣除</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 10px; font-size: 14px; border-radius: 10px;">取消</button>
    </div>
</div>

<div id="editWeightModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 id="editWeightModalTitle" style="font-size: 18px; color: #333; margin-bottom: 25px;">修改库存重量</h3>
    
    <div class="input-group" style="margin-bottom: 25px;">
        <input type="number" id="editWeightInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
        <span class="input-suffix" style="right: 30px; font-size: 16px; color: #999;">g</span>
    </div>
    
    <div class="modal-btn-group" style="gap: 12px;">
        <button class="m-btn m-btn-primary" onclick="submitEditWeight()" style="padding: 12px; font-size: 16px; border-radius: 12px; background: linear-gradient(135deg, #4a90e2, #357abd); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">确认修改</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; color: #666;">取消</button>
    </div>
</div>

<div id="restockModal" class="modal">
    <h3>新增补货</h3>
    <div class="modal-desc" id="restockTitle"></div>
    <div class="input-group">
        <input type="number" id="restockInput" placeholder="0" step="0.01">
        <span class="input-suffix">g</span>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRestock()">确认补货</button>
        <button class="m-btn m-btn-ghost" onclick="showModal('editWeightModal')">返回</button>
    </div>
</div>

<div id="historyModal" class="modal" style="width:85%; max-width:340px;">
    <h3 id="historyTitle" style="font-size:16px; font-weight:bold; margin-bottom:12px;">库存明细</h3>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f5f7fa; padding:10px; border-radius:10px;">
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">当前余量</div>
            <div id="hist-stock" style="font-size:16px; font-weight:bold; color:#4a90e2;">0g</div>
        </div>
        <div style="text-align:center; border-left:1px solid #e0e0e0; border-right:1px solid #e0e0e0; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">总消耗</div>
            <div id="hist-used" style="font-size:16px; font-weight:bold; color:#ff4d4f;">0g</div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">总补充</div>
            <div id="hist-added" style="font-size:16px; font-weight:bold; color:#52c41a;">0g</div>
        </div>
    </div>

    <div style="max-height:240px; overflow-y:auto; border:1px solid #eee; border-radius:10px;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead style="background:#fafafa; position:sticky; top:0;">
                <tr>
                    <th style="padding:8px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">时间</th>
                    <th style="padding:8px; text-align:center; color:#999; font-weight:normal; border-bottom:1px solid #eee;">操作</th>
                    <th style="padding:8px; text-align:right; color:#999; font-weight:normal; border-bottom:1px solid #eee;">重量/粒数</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>

    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:8px; font-size:13px;">关闭</button>
    </div>
</div>

<div id="helpModal" class="modal">
    <h3>使用说明</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:14px; max-height:400px; overflow-y:auto; padding:0 5px;">
        <p style="margin-bottom:10px;"><b>1. 初始录入：</b><br>点击“初始录入”，可一次性粘贴多行数据（格式：色号 数量），快速初始化库存。</p>
        <p style="margin-bottom:10px;"><b>2. 消耗录入：</b><br>点击色号选中（可多选） -> 点击底部“录入粒数” -> 输入消耗粒数 -> 自动扣除对应重量。<br><span style="color:#888; font-size:12px;">(按1g=100粒计算)</span></p>
        <p style="margin-bottom:10px;"><b>3. 补货/修改库存：</b><br>直接点击列表中的“库存重量”数字 -> 输入最新重量 -> 确认。<br>也可点击“+10g”按钮快速补货。<br>
        <span style="color:#888; font-size:12px;">(系统会自动根据重量变化记录为“补货”或“消耗”)</span></p>
        <p style="margin-bottom:10px;"><b>4. 历史记录：</b><br>点击列表中的“累计消耗” -> 查看详细记录。<br>支持删除某条记录，删除后库存会自动回滚。</p>
        <p style="margin-bottom:10px;"><b>5. 数据备份：</b><br>点击“数据管理” -> 复制备份代码保存。换设备时使用“恢复导入”。</p>
        <p style="margin-bottom:10px;"><b>6. 阈值与补货单：</b><br>设置“阈值”（例如 5g），库存低于此值的色号会变红预警。<br>点击“查看补货单”可查看所有低库存色号及当前库存，支持一键复制。</p>
        <p style="margin-bottom:10px;"><b>7. 搜索功能：</b><br>在顶部输入框输入色号（支持部分匹配），可快速筛选显示对应颜色的库存。</p>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()">知道了</button>
    </div>
</div>

<div id="dataModal" class="modal">
    <h3>数据管理</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px; background:#f3f4f6; padding:4px; border-radius:12px;">
        <button id="tabBackup" class="m-btn m-btn-ghost" style="flex:1; padding:8px; font-size:13px;" onclick="switchDataTab('backup')">备份导出</button>
        <button id="tabRestore" class="m-btn m-btn-ghost" style="flex:1; padding:8px; font-size:13px;" onclick="switchDataTab('restore')">恢复导入</button>
    </div>
    
    <div id="viewBackup">
        <div class="modal-desc">复制下方代码保存到备忘录</div>
        <textarea id="backupOutput" style="width:100%; height:100px; padding:10px; border:1px solid #eee; border-radius:12px; resize:none; font-family:monospace; font-size:12px; box-sizing:border-box; background:#f9f9f9; color:#666;" readonly onclick="this.select()"></textarea>
        <button class="m-btn m-btn-primary" style="margin-top:15px;" onclick="copyBackup()">复制到剪贴板</button>
    </div>

    <div id="viewRestore" style="display:none;">
        <div class="modal-desc">将备份代码粘贴到下方</div>
        <textarea id="restoreInput" style="width:100%; height:100px; padding:10px; border:1px solid #eee; border-radius:12px; resize:none; font-family:monospace; font-size:12px; box-sizing:border-box;" placeholder="粘贴备份代码..."></textarea>
        <button class="m-btn m-btn-primary" style="margin-top:15px; background:var(--warn);" onclick="execRestore()">确认覆盖恢复</button>
    </div>
    <button class="m-btn m-btn-ghost" style="margin-top:10px;" onclick="closeAllModals()">关闭</button>
</div>

<div id="batchInputModal" class="modal">
    <h3>初始数据批量录入</h3>
    <div class="modal-desc">格式：色号+重量 (如 A1 50 B2 100)</div>
    <textarea id="batchInputText" style="width:100%; height:150px; padding:15px; border:1px solid #eee; border-radius:12px; resize:none; font-family:monospace; font-size:14px; box-sizing:border-box; background:#f9f9f9;" placeholder="支持多种格式，例如：&#10;A1 50&#10;B2: 20.5&#10;C3=100"></textarea>
    <div class="modal-btn-group" style="margin-top:20px;">
        <button class="m-btn m-btn-primary" onclick="submitBatchInput()">开始识别并导入</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">取消</button>
    </div>
</div>

<div id="lowStockModal" class="modal" style="width:85%; max-width:340px; padding:20px; border-radius:24px;">
    <h3 style="font-size:18px; font-weight:bold; margin-bottom:20px; text-align:center; color:#333;">补货清单</h3>
    <div style="margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:8px; border:1px solid #ffe58f; display:flex; align-items:center; gap:8px;">
        <span style="font-size:16px;">⚠️</span>
        <div class="modal-desc" style="font-size:12px; color:#d48806; margin:0; text-align:left;">以下色号库存低于设定阈值，建议及时补货。</div>
    </div>
    
    <div id="lowStockList" style="max-height:260px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px; margin-bottom:20px; padding:5px;"></div>
    
    <!-- 隐藏的文本域用于复制功能 -->
    <textarea id="lowStockText" style="position:absolute; left:-9999px;"></textarea>

    <div class="modal-btn-group" style="gap:10px;">
        <button class="m-btn m-btn-primary" style="padding:12px; font-size:15px; border-radius:12px;" onclick="copyLowStockText()">一键复制清单</button>
        <button class="m-btn m-btn-ghost" style="padding:12px; font-size:15px; border-radius:12px;" onclick="closeAllModals()">关闭</button>
    </div>
</div>

<div id="welcomeModal" class="modal">
    <h3>📢 欢迎使用 MARD 豆库</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:14px; padding:0 10px;">
        <p style="margin-bottom:12px;"><b>1. 数据安全提醒：</b><br>
        本工具数据<span style="color:#ff4d4f; font-weight:bold;">仅存储在您的浏览器缓存中</span>。清理浏览器缓存会导致数据丢失！<br>
        请务必定期备份数据（功能入口：右上角“数据管理” -> “备份导出”），作者不承担数据丢失的任何后果。</p>
        
        <p style="margin-bottom:12px;"><b>2. 设备同步：</b><br>
        本工具为离线网页应用，<span style="color:#ff4d4f; font-weight:bold;">不支持多设备实时同步</span>。如需在其他设备使用，请使用备份/恢复功能手动迁移数据。</p>
        
        <p style="margin-bottom:12px;"><b>3. 功能说明：</b><br>
        详细操作指南请点击页面右上角的“📖 使用说明”。</p>
    </div>
    <div class="modal-btn-group" style="margin-top:20px;">
        <button class="m-btn m-btn-primary" onclick="closeWelcomeModal()">我已知晓</button>
    </div>
</div>

<div id="devInfoModal" class="modal" style="width:70%; max-width:260px; padding:15px;">
    <h3 style="font-size:16px;">开发者信息</h3>
    <div style="text-align:center; padding:10px; color:#555; font-size:13px; line-height:1.6;">
        <p><b>开发者:</b> 小红书用户āōē</p>
        <p><b>ID:</b> 11535779483</p>
        <p>使用 AI 工具开发</p>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="closeAllModals()">关闭</button>
    </div>
</div>

<script>
    const MARD_DB = [
        {id:'A1',hex:'#faf5cd'},{id:'A2',hex:'#fcfed6'},{id:'A3',hex:'#fcff92'},{id:'A4',hex:'#f7ec5c'},{id:'A5',hex:'#f0d83a'},{id:'A6',hex:'#fda951'},{id:'A7',hex:'#fa8c4f'},{id:'A8',hex:'#fbda4d'},{id:'A9',hex:'#f79d5f'},{id:'A10',hex:'#f47e38'},{id:'A11',hex:'#fedb99'},{id:'A12',hex:'#fda276'},{id:'A13',hex:'#fec667'},{id:'A14',hex:'#f75842'},{id:'A15',hex:'#fbf65e'},{id:'A16',hex:'#feff97'},{id:'A17',hex:'#fde173'},{id:'A18',hex:'#fcbf80'},{id:'A19',hex:'#fd7e77'},{id:'A20',hex:'#f9d66e'},{id:'A21',hex:'#fae393'},{id:'A22',hex:'#edf878'},{id:'A23',hex:'#e4c8ba'},{id:'A24',hex:'#f3f6a9'},{id:'A25',hex:'#ffd785'},{id:'A26',hex:'#ffc734'},
        {id:'B1',hex:'#dff13b'},{id:'B2',hex:'#64f343'},{id:'B3',hex:'#a1f586'},{id:'B4',hex:'#5fdf34'},{id:'B5',hex:'#39e158'},{id:'B6',hex:'#64e0a4'},{id:'B7',hex:'#3eae7c'},{id:'B8',hex:'#1d9b54'},{id:'B9',hex:'#2a5037'},{id:'B10',hex:'#9ad1ba'},{id:'B11',hex:'#627032'},{id:'B12',hex:'#1a6e3d'},{id:'B13',hex:'#c8e87d'},{id:'B14',hex:'#abe84f'},{id:'B15',hex:'#305335'},{id:'B16',hex:'#c0ed9c'},{id:'B17',hex:'#9eb33e'},{id:'B18',hex:'#e6ed4f'},{id:'B19',hex:'#26b78e'},{id:'B20',hex:'#cbeccf'},{id:'B21',hex:'#18616a'},{id:'B22',hex:'#0a4241'},{id:'B23',hex:'#343b1a'},{id:'B24',hex:'#e8faa6'},{id:'B25',hex:'#4e846d'},{id:'B26',hex:'#907c35'},{id:'B27',hex:'#d0e0af'},{id:'B28',hex:'#9ee5bb'},{id:'B29',hex:'#c6df5f'},{id:'B30',hex:'#e3fbb1'},{id:'B31',hex:'#b4e691'},{id:'B32',hex:'#92ad60'},
        {id:'C1',hex:'#f0fee4'},{id:'C2',hex:'#abf8fe'},{id:'C3',hex:'#a2e0f7'},{id:'C4',hex:'#44cdfb'},{id:'C5',hex:'#06aadf'},{id:'C6',hex:'#54a7e9'},{id:'C7',hex:'#3977ca'},{id:'C8',hex:'#0f52bd'},{id:'C9',hex:'#3349c3'},{id:'C10',hex:'#3cbce3'},{id:'C11',hex:'#2aded3'},{id:'C12',hex:'#1e334e'},{id:'C13',hex:'#cde7fe'},{id:'C14',hex:'#d5fcf7'},{id:'C15',hex:'#21c5c4'},{id:'C16',hex:'#1858a2'},{id:'C17',hex:'#02d1f3'},{id:'C18',hex:'#213244'},{id:'C19',hex:'#18869d'},{id:'C20',hex:'#1a70a9'},{id:'C21',hex:'#bcddfc'},{id:'C22',hex:'#6bb1bb'},{id:'C23',hex:'#c8e2fd'},{id:'C24',hex:'#7ec5f9'},{id:'C25',hex:'#a9e8e0'},{id:'C26',hex:'#42adcf'},{id:'C27',hex:'#d0def9'},{id:'C28',hex:'#bdcee8'},{id:'C29',hex:'#364a89'},
        {id:'D1',hex:'#acb7ef'},{id:'D2',hex:'#868dd3'},{id:'D3',hex:'#3554af'},{id:'D4',hex:'#162d7b'},{id:'D5',hex:'#b34ec6'},{id:'D6',hex:'#b37bdc'},{id:'D7',hex:'#8758a9'},{id:'D8',hex:'#e3d2fe'},{id:'D9',hex:'#d5b9f4'},{id:'D10',hex:'#301a49'},{id:'D11',hex:'#beb9e2'},{id:'D12',hex:'#dc99ce'},{id:'D13',hex:'#b5038d'},{id:'D14',hex:'#862993'},{id:'D15',hex:'#2f1f8c'},{id:'D16',hex:'#e2e4f0'},{id:'D17',hex:'#c7d3f9'},{id:'D18',hex:'#9a64b8'},{id:'D19',hex:'#d8c2d9'},{id:'D20',hex:'#9a35ad'},{id:'D21',hex:'#940595'},{id:'D22',sweet:'#38389a'},{id:'D23',hex:'#eadbf8'},{id:'D24',hex:'#768ae1'},{id:'D25',hex:'#4950c2'},{id:'D26',hex:'#d6c6eb'},
        {id:'E1',hex:'#f6d4cb'},{id:'E2',hex:'#fcc1dd'},{id:'E3',hex:'#f6bde8'},{id:'E4',hex:'#e8649e'},{id:'E5',hex:'#f0569f'},{id:'E6',hex:'#eb4172'},{id:'E7',hex:'#c53674'},{id:'E8',hex:'#fddbe9'},{id:'E9',hex:'#e376c7'},{id:'E10',hex:'#d13b95'},{id:'E11',hex:'#f7dad4'},{id:'E12',hex:'#f693bf'},{id:'E13',hex:'#b5026a'},{id:'E14',hex:'#fad4bf'},{id:'E15',hex:'#f5c9ca'},{id:'E16',hex:'#fbf4ec'},{id:'E17',hex:'#f7e3ec'},{id:'E18',hex:'#f9c8db'},{id:'E19',hex:'#f6bbd1'},{id:'E20',hex:'#d7c6ce'},{id:'E21',hex:'#c09da4'},{id:'E22',hex:'#b38c9f'},{id:'E23',hex:'#937d8a'},{id:'E24',hex:'#debee5'},
        {id:'F1',hex:'#fe9381'},{id:'F2',hex:'#f63d4b'},{id:'F3',hex:'#ee4e3e'},{id:'F4',hex:'#fb2a40'},{id:'F5',hex:'#e10328'},{id:'F6',hex:'#913635'},{id:'F7',hex:'#911932'},{id:'F8',hex:'#bb0126'},{id:'F9',hex:'#e0677a'},{id:'F10',hex:'#874628'},{id:'F11',hex:'#592323'},{id:'F12',hex:'#f3536b'},{id:'F13',hex:'#f45c45'},{id:'F14',hex:'#fcadb2'},{id:'F15',hex:'#d50527'},{id:'F16',hex:'#f8c0a9'},{id:'F17',hex:'#e89b7d'},{id:'F18',hex:'#d07f4a'},{id:'F19',hex:'#be454a'},{id:'F20',hex:'#c69495'},{id:'F21',hex:'#f2b8c6'},{id:'F22',hex:'#f7c3d0'},{id:'F23',hex:'#ed806c'},{id:'F24',hex:'#e09daf'},{id:'F25',hex:'#e84854'},
        {id:'G1',hex:'#ffe4d3'},{id:'G2',hex:'#fcc6ac'},{id:'G3',hex:'#f1c4a5'},{id:'G4',hex:'#dcb387'},{id:'G5',hex:'#e7b34e'},{id:'G6',hex:'#e3a014'},{id:'G7',hex:'#985c3a'},{id:'G8',hex:'#713d2f'},{id:'G9',hex:'#e4b685'},{id:'G10',hex:'#da8c42'},{id:'G11',hex:'#dac898'},{id:'G12',hex:'#fec993'},{id:'G13',hex:'#b2714b'},{id:'G14',hex:'#8b684c'},{id:'G15',hex:'#f6f8e3'},{id:'G16',hex:'#f2d8c1'},{id:'G17',hex:'#77544e'},{id:'G18',hex:'#ffe3d5'},{id:'G19',hex:'#dd7d41'},{id:'G20',hex:'#a5452f'},{id:'G21',hex:'#b38561'},
        {id:'H1',hex:'#ffffff'},{id:'H2',hex:'#fbfbfb'},{id:'H3',hex:'#b4b4b4'},{id:'H4',hex:'#878787'},{id:'H5',hex:'#464646'},{id:'H6',hex:'#2c2c2c'},{id:'H7',hex:'#010101'},{id:'H8',hex:'#e7d6dc'},{id:'H9',hex:'#efedee'},{id:'H10',hex:'#ebebeb'},{id:'H11',hex:'#cdcdcd'},{id:'H12',hex:'#fdf6ee'},{id:'H13',hex:'#f4efd1'},{id:'H14',hex:'#ced7d4'},{id:'H15',hex:'#9aa6a6'},{id:'H16',hex:'#1b1213'},{id:'H17',hex:'#f0eeef'},{id:'H18',hex:'#fcfff6'},{id:'H19',hex:'#f2eee5'},{id:'H20',hex:'#96a09f'},{id:'H21',hex:'#f8fbe6'},{id:'H22',hex:'#cacad2'},{id:'H23',hex:'#9b9c94'},
        {id:'M1',hex:'#bbc6b6'},{id:'M2',hex:'#909994'},{id:'M3',hex:'#697e81'},{id:'M4',hex:'#e0d4bc'},{id:'M5',hex:'#d1ccaf'},{id:'M6',hex:'#b0aa86'},{id:'M7',hex:'#b0a796'},{id:'M8',hex:'#ae8082'},{id:'M9',hex:'#a68862'},{id:'M10',hex:'#c4b3bb'},{id:'M11',hex:'#9d7693'},{id:'M12',hex:'#644b51'},{id:'M13',hex:'#c79266'},{id:'M14',hex:'#c27563'},{id:'M15',hex:'#747d7a'}
    ];

    let data = JSON.parse(localStorage.getItem('bead_v_sort')) || MARD_DB.map(i => ({...i, w: 0, totalUsed: 0, logs: []}));
    let threshold = parseFloat(localStorage.getItem('bead_threshold')) || 5;
    document.getElementById('threshold').value = threshold; // 修复阈值回显
    let currentSortMode = 'id'; // 排序模式状态
    let sel = new Set();
    let currentEditId = null;

    function formatTime(now) {
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}:${s}`;
    }

    let collapsedSeries = new Set();

    function toggleSeries(key) {
        if(collapsedSeries.has(key)) collapsedSeries.delete(key);
        else collapsedSeries.add(key);
        render();
    }

    function createRow(item) {
        const isLow = item.w < threshold;
        const grainCount = Math.round(item.w * 100);
        
        // 计算总补货
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
             totalAdded = item.totalAdded;
        } else {
            // 兼容逻辑：从 logs 计算并初始化
            if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type === 'add') totalAdded += (log.val || 0);
                 });
            }
            totalAdded = parseFloat(totalAdded.toFixed(2));
            // 初始化字段以便后续累加
            item.totalAdded = totalAdded; 
        }
        
        const totalUsed = item.totalUsed || 0;

        const row = document.createElement('div');
        row.className = `bead-row ${sel.has(item.id) ? 'selected' : ''}`;
        row.onclick = () => toggleSelect(item.id);
        
        row.innerHTML = `
            <div class="col-select"><input type="checkbox" ${sel.has(item.id)?'checked':''}></div>
            <div class="col-color"><div class="swatch" style="background:${item.hex}"></div></div>
            <div class="col-id">${item.id}</div>
            <div class="col-weight" style="display:flex; flex-direction:column; justify-content:center; gap:2px;">
                <div class="weight-primary-row" style="display:flex; align-items:center; gap:15px;">
                    <div style="cursor:pointer; display:flex; align-items:baseline;" onclick="event.stopPropagation(); manualEdit('${item.id}')">
                        <span class="weight-badge ${isLow ? 'low' : ''}">${item.w}g</span>
                        <span class="grain-info" style="font-size:10px; color:#999; margin-left:4px;">≈${grainCount}粒</span>
                    </div>
                </div>
                <div class="weight-detail-row" style="font-size:10px; color:#999; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                     <span style="white-space:nowrap;">总耗: <b style="color:#ff4d4f; font-weight:normal;">${totalUsed}g</b></span>
                     <span style="white-space:nowrap;">总补: <b style="color:#52c41a; font-weight:normal;">${totalAdded}g</b></span>
                     <button class="btn-detail" onclick="event.stopPropagation(); openHistory('${item.id}')">查看明细</button>
                </div>
            </div>
            <div class="col-action">
                <button class="btn-plus" onclick="event.stopPropagation(); quickAdd('${item.id}')">+10g</button>
            </div>
        `;
        return row;
    }

    function render() {
        const q = document.getElementById('search').value.toUpperCase();
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        let displayData = [...data];
        
        // 排序逻辑
        if (currentSortMode === 'usage_desc') {
            displayData.sort((a, b) => (b.totalUsed || 0) - (a.totalUsed || 0));
        } else if (currentSortMode === 'usage_asc') {
            displayData.sort((a, b) => (a.totalUsed || 0) - (b.totalUsed || 0));
        } else if (currentSortMode === 'stock_desc') {
            displayData.sort((a, b) => b.w - a.w); // 降序
        } else if (currentSortMode === 'stock_asc') {
            displayData.sort((a, b) => a.w - b.w); // 升序
        } else if (currentSortMode.startsWith('restock')) {
             displayData.sort((a, b) => {
                 const getRestock = (item) => {
                     if(!item.logs) return 0;
                     return item.logs.reduce((sum, log) => sum + (log.type === 'add' ? (log.val||0) : 0), 0);
                 };
                 const valA = getRestock(a);
                 const valB = getRestock(b);
                 return currentSortMode === 'restock_desc' ? valB - valA : valA - valB;
             });
        } else {
            // 默认按ID字母+数字排序
            displayData.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true, sensitivity: 'base'}));
        }

        // 计算低库存数量（基于当前搜索过滤）
        let lowCount = 0;
        displayData.forEach(item => {
            if (item.id.includes(q)) {
                if(item.w < threshold) lowCount++;
            }
        });
        document.getElementById('count-low').innerText = lowCount;

        // 分组显示逻辑（仅在默认排序且无搜索时启用）
        if (currentSortMode === 'id' && q === '') {
             const groups = {};
             displayData.forEach(item => {
                 let key = item.id.charAt(0).toUpperCase();
                 if (!/^[A-Z]/.test(key)) key = '#'; // 非字母开头归入#
                 if(!groups[key]) groups[key] = [];
                 groups[key].push(item);
             });
             
             Object.keys(groups).sort().forEach(series => {
                 const items = groups[series];
                 const isCollapsed = collapsedSeries.has(series);
                 
                 const header = document.createElement('div');
                 header.onclick = () => toggleSeries(series);
                 header.style.cssText = 'background:#f8f9fa; padding:10px 15px; font-weight:bold; color:#555; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center;';
                 header.innerHTML = `
                    <span>${series}系列 (${items.length})</span>
                    <span style="transform:${isCollapsed?'rotate(-90deg)':'rotate(0deg)'}; transition:transform 0.2s;">▼</span>
                 `;
                 grid.appendChild(header);
                 
                 if(!isCollapsed) {
                     items.forEach(item => {
                         grid.appendChild(createRow(item));
                     });
                 }
             });
        } else {
             // 扁平列表模式
             displayData.forEach(item => {
                 if (item.id.includes(q)) {
                     grid.appendChild(createRow(item));
                 }
             });
        }
        
        save();
    }

    function changeSortMode() {
        currentSortMode = document.getElementById('sortSelect').value;
        render();
    }

    function toggleSelect(id) {
        sel.has(id) ? sel.delete(id) : sel.add(id);
        updateFooter();
        render();
    }
    
    function cancelSelection() {
        sel.clear();
        updateFooter();
        render();
    }
    
    function updateFooter() {
        document.getElementById('footer').style.display = sel.size > 0 ? 'flex' : 'none';
        document.getElementById('selNum').innerText = sel.size;
    }

    function updateThreshold() {
        threshold = parseFloat(document.getElementById('threshold').value) || 0;
        localStorage.setItem('bead_threshold', threshold);
        render();
    }

    function quickAdd(id) {
        const item = data.find(d => d.id === id);
        const addVal = 10;
        item.w = parseFloat((item.w + addVal).toFixed(2));
        // 维护总补货量
        item.totalAdded = parseFloat(((item.totalAdded || 0) + addVal).toFixed(2));
        
        // 记录补货日志
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: addVal });
        if(item.logs.length > 20) item.logs.shift(); // 增加日志保留条数
        
        save(); // 增加保存
        render();
    }

    function manualEdit(id) {
        currentEditId = id;
        const item = data.find(d => d.id === id);
        document.getElementById('editWeightModalTitle').innerText = `修改库存重量 ${id}`;
        const input = document.getElementById('editWeightInput');
        input.value = item.w;
        showModal('editWeightModal');
        setTimeout(() => input.select(), 50);
        
        // 绑定回车事件
        input.onkeydown = function(e) {
            if(e.key === 'Enter') submitEditWeight();
        }
    }

    function openRestockModal() {
        if(!currentEditId) return;
        document.getElementById('restockTitle').innerText = `正在为色号 [${currentEditId}] 补货`;
        document.getElementById('restockInput').value = '';
        showModal('restockModal');
        setTimeout(() => document.getElementById('restockInput').focus(), 50);
        
        document.getElementById('restockInput').onkeydown = function(e) {
            if(e.key === 'Enter') submitRestock();
        }
    }

    function submitRestock() {
        const val = parseFloat(document.getElementById('restockInput').value);
        if(!currentEditId || isNaN(val) || val <= 0) {
            alert("请输入有效的补货重量");
            return;
        }
        
        const item = data.find(d => d.id === currentEditId);
        item.w = parseFloat((item.w + val).toFixed(2));
        // 维护总补货量
        item.totalAdded = parseFloat(((item.totalAdded || 0) + val).toFixed(2));
        
        // 记录日志
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: val });
        if(item.logs.length > 20) item.logs.shift();
        
        save();
        render();
        closeAllModals();
        alert(`已成功补货 ${val}g`);
    }

    function openHistory(id) {
        const item = data.find(d => d.id === id);
        if(!item) return; // 容错处理

        // 1. 设置标题和概览数据
        document.getElementById('historyTitle').innerHTML = `色号 ${id} 明细`;
        document.getElementById('hist-stock').innerText = (item.w || 0) + 'g';
        document.getElementById('hist-used').innerText = (item.totalUsed || 0) + 'g';
        
        // 计算总补充：优先使用持久化字段
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
            totalAdded = item.totalAdded;
        } else {
            if(item.logs) {
                item.logs.forEach(log => {
                    if(log.type === 'add') {
                        totalAdded += (log.val || 0);
                    }
                });
            }
        }
        document.getElementById('hist-added').innerText = parseFloat(totalAdded.toFixed(2)) + 'g';

        // 2. 渲染记录表格
        const tbody = document.getElementById('historyList');
        tbody.innerHTML = '';
        
        if (item.logs && item.logs.length > 0) {
            // 给日志加上原始索引，方便删除
            const logsWithIdx = item.logs.map((log, idx) => ({...log, idx}));
            
            // 倒序显示
            logsWithIdx.reverse().forEach(log => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f0f0f0';
                
                // --- 时间列 ---
                const tdTime = document.createElement('td');
                tdTime.style.padding = '10px';
                tdTime.style.color = '#666';
                tdTime.innerText = log.d;
                tr.appendChild(tdTime);
                
                // --- 操作类型列 ---
                const tdType = document.createElement('td');
                tdType.style.padding = '10px';
                tdType.style.textAlign = 'center';
                
                let typeText = '';
                let typeColor = '#333';
                
                if (log.type === 'add') {
                    typeText = '补货';
                    typeColor = '#52c41a'; // 绿色
                } else {
                    typeText = '消耗';
                    typeColor = '#ff4d4f'; // 红色
                }
                
                tdType.innerHTML = `<span style="background:${typeColor}15; color:${typeColor}; padding:2px 6px; border-radius:4px; font-size:11px;">${typeText}</span>`;
                tr.appendChild(tdType);
                
                // --- 重量/粒数及删除列 ---
                const tdVal = document.createElement('td');
                tdVal.style.padding = '10px';
                tdVal.style.textAlign = 'right';
                
                let valHtml = '';
                if (log.type === 'add') {
                    valHtml = `<span style="color:#333;">+${log.val}g</span>`;
                } else {
                    const count = log.c || log.val || 0;
                    const weight = (count / 100).toFixed(2);
                    // 如果是手动调整且没有具体粒数记录（旧数据兼容），优先显示重量
                    if (log.isManual) {
                         valHtml = `<span style="color:#333;">-${weight}g</span>`;
                    } else {
                         valHtml = `<span style="color:#333;">${count}粒</span><br><span style="font-size:10px; color:#999;">≈ ${weight}g</span>`;
                    }
                }
                
                // 删除按钮
                const delBtn = `<button onclick="deleteLog('${id}', ${log.idx})" style="margin-left:8px; border:none; background:none; color:#999; cursor:pointer; font-size:16px; padding:0;">×</button>`;
                
                tdVal.innerHTML = `<div style="display:flex; align-items:center; justify-content:flex-end;"><div>${valHtml}</div>${delBtn}</div>`;
                tr.appendChild(tdVal);
                
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="3" style="padding:20px; text-align:center; color:#999;">暂无记录</td>';
            tbody.appendChild(tr);
        }
        
        showModal('historyModal');
    }

    function deleteLog(id, logIdx) {
        if(!confirm("确认删除这条记录吗？\n删除后将自动回滚库存变化。")) return;
        
        const item = data.find(d => d.id === id);
        if(!item || !item.logs || !item.logs[logIdx]) return;
        
        const log = item.logs[logIdx];
        
        if (log.type === 'add') {
            // 回滚补货：减少库存
            item.w = Math.max(0, parseFloat((item.w - log.val).toFixed(2)));
            // 回滚总补货
            item.totalAdded = Math.max(0, parseFloat(((item.totalAdded || 0) - log.val).toFixed(2)));
        } else {
            // 回滚消耗：增加库存，减少累计消耗
            const count = log.c || log.val || 0;
            const g = parseFloat((count / 100).toFixed(2));
            item.w = parseFloat((item.w + g).toFixed(2));
            item.totalUsed = Math.max(0, parseFloat((item.totalUsed - g).toFixed(2)));
        }
        
        // 删除记录
        item.logs.splice(logIdx, 1);
        
        save();
        render();
        // 重新渲染当前打开的历史弹窗
        openHistory(id);
    }

    function submitEditWeight() {
        if(!currentEditId) return;
        const input = document.getElementById('editWeightInput');
        const val = parseFloat(input.value);
        
        // 保持原有逻辑：输入无效数字则视为0
        const finalVal = (!isNaN(val) && val >= 0) ? val : 0;
        
        const item = data.find(d => d.id === currentEditId);
        if(item) {
            const oldVal = item.w;
            const diff = finalVal - oldVal;
            
            // 更新库存
            item.w = parseFloat(finalVal.toFixed(2));
            
            // 自动记录日志 (忽略极小差异)
            if (Math.abs(diff) > 0.001) {
                const now = new Date();
                const dateStr = formatTime(now);
                if(!item.logs) item.logs = [];
                
                if (diff > 0) {
                    const addedVal = parseFloat(diff.toFixed(2));
                    // 增加库存 -> 视为补货
                    item.logs.push({ d: dateStr, type: 'add', val: addedVal, isManual: true });
                    // 维护总补货量
                    item.totalAdded = parseFloat(((item.totalAdded || 0) + addedVal).toFixed(2));
                } else {
                    // 减少库存 -> 视为消耗
                    const loss = -diff;
                    // 更新累计消耗
                    item.totalUsed = parseFloat(((item.totalUsed || 0) + loss).toFixed(2));
                    // 记录为消耗 (折算为粒数，假设 1g = 100 粒)
                    item.logs.push({ d: dateStr, c: Math.round(loss * 100), isManual: true });
                }
                
                if(item.logs.length > 20) item.logs.shift();
            }
            
            render();
        }
        
        closeAllModals();
        currentEditId = null;
        input.onkeydown = null;
    }

    function openConsumeModal() {
        const listDiv = document.getElementById('modalList');
        listDiv.innerHTML = '';
        
        if (sel.size === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">未选择任何色号</div>';
            showModal('consumeModal');
            return;
        }

        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            const currentStockGrains = Math.round(item.w * 100); // 当前库存粒数
            
            const row = document.createElement('div');
            row.className = 'modal-row';
            // 使用自定义样式覆盖默认 modal-row
            row.style.cssText = 'display:flex; flex-direction:column; padding: 12px; border-bottom: 1px solid #f0f0f0; background:white; align-items: stretch;';
            
            row.innerHTML = `
                <div style="display:flex; align-items:center; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap: 12px;">
                        <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                        <div style="display:flex; flex-direction:column;">
                            <b style="font-size:16px; color:#333;">${id}</b>
                            <span style="font-size:11px; color:#999;">库存: ${currentStockGrains}粒</span>
                        </div>
                    </div>
                    <div style="position:relative;">
                        <input type="number" class="consume-input" data-id="${id}" data-stock="${currentStockGrains}" placeholder="0" oninput="checkConsumeLimit(this)" 
                               style="width: 70px; padding: 8px 5px; border: 1px solid #e0e0e0; border-radius: 8px; text-align: center; font-size: 16px; font-weight:bold; color:#333; outline:none; background:#f9fafb; transition: all 0.2s;">
                    </div>
                </div>
                <div class="limit-warn" id="warn-${id}" style="width:100%; color:#ff4d4f; font-size:11px; margin-top:8px; display:none; text-align:right; background:#fff1f0; padding:4px 8px; border-radius:4px;">
                     ⚠️ 消耗量超过库存 (${currentStockGrains})
                </div>
            `;
            listDiv.appendChild(row);
        });
        
        // 去除最后一行边框
        if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';
        
        showModal('consumeModal');
        
        // 自动聚焦第一个输入框
        setTimeout(() => {
            const firstInput = listDiv.querySelector('input');
            if(firstInput) firstInput.focus();
        }, 100);
    }

    function checkConsumeLimit(input) {
        const val = parseFloat(input.value) || 0;
        const stock = parseFloat(input.getAttribute('data-stock'));
        const id = input.getAttribute('data-id');
        const warnEl = document.getElementById(`warn-${id}`);
        
        if (val > stock) {
            warnEl.style.display = 'block';
        } else {
            warnEl.style.display = 'none';
        }
    }

    function submitConsume() {
        const inputs = document.querySelectorAll('.consume-input');
        const now = new Date();
        const dateStr = formatTime(now);
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            const count = parseFloat(input.value) || 0;
            if(count > 0) {
                const item = data.find(d => d.id === id);
                const g = count / 100;
                item.w = Math.max(0, parseFloat((item.w - g).toFixed(2)));
                item.totalUsed = parseFloat(((item.totalUsed || 0) + g).toFixed(2));
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, c: count });
                if(item.logs.length > 10) item.logs.shift();
            }
        });
        closeAllModals();
        sel.clear();
        document.getElementById('footer').style.display = 'none';
        render();
    }

    function showModal(id) {
        document.getElementById('mask').style.display = 'block';
        document.getElementById(id).style.display = 'block';
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(el => el.style.display = 'none');
        document.getElementById('mask').style.display = 'none';
    }

    // 兼容旧函数调用，防止遗漏
    function closeModal() { closeAllModals(); }

    function save() { localStorage.setItem('bead_v_sort', JSON.stringify(data)); }

    // --- 数据管理功能 ---
    function openDataModal(tab) {
        showModal('dataModal');
        switchDataTab(tab);
        if(tab === 'backup') {
            // 导出格式：色号 数量 (导出所有库存数据)
            const text = data.map(d => `${d.id} ${d.w}`)
                             .join('\n');
            document.getElementById('backupOutput').value = text || '无数据';
        } else {
            document.getElementById('restoreInput').value = '';
        }
    }

    function switchDataTab(tab) {
        document.getElementById('tabBackup').className = tab==='backup' ? 'm-btn m-btn-primary' : 'm-btn m-btn-ghost';
        document.getElementById('tabRestore').className = tab==='restore' ? 'm-btn m-btn-primary' : 'm-btn m-btn-ghost';
        document.getElementById('viewBackup').style.display = tab==='backup' ? 'block' : 'none';
        document.getElementById('viewRestore').style.display = tab==='restore' ? 'block' : 'none';
    }

    function copyBackup() {
        const el = document.getElementById('backupOutput');
        el.select();
        navigator.clipboard.writeText(el.value).then(() => alert("已复制到剪贴板"));
    }

    function execRestore() {
        const code = document.getElementById('restoreInput').value.trim();
        if(!code) return;
        
        if(!confirm("警告：恢复操作将重置当前所有库存数据，然后导入新数据。\n确认继续吗？")) return;

        // 解析文本格式
        const regex = /([A-Z][0-9]+)[^0-9\.]*(\d+(\.\d+)?)/gi;
        let match;
        const newStock = {};
        let count = 0;

        while ((match = regex.exec(code)) !== null) {
            const id = match[1].toUpperCase();
            const w = parseFloat(match[2]);
            newStock[id] = w;
            count++;
        }

        if (count === 0) {
            alert("未识别到有效数据，请检查格式 (如: A1 50)");
            return;
        }

        // 应用数据：重置所有库存，填入新库存
        data.forEach(item => {
            if (newStock[item.id] !== undefined) {
                item.w = newStock[item.id];
            } else {
                item.w = 0; // 备份中不存在的色号，库存归零
            }
        });

        save();
        render();
        closeAllModals();
        alert(`已成功恢复 ${count} 条库存记录`);
    }

    // --- 批量初始录入功能 ---
    function openBatchInput() {
        document.getElementById('batchInputText').value = '';
        showModal('batchInputModal');
    }

    function submitBatchInput() {
        const text = document.getElementById('batchInputText').value;
        const regex = /([A-Z][0-9]+)[^0-9\.]*(\d+(\.\d+)?)/gi;
        let match;
        let count = 0;
        while ((match = regex.exec(text)) !== null) {
            const id = match[1].toUpperCase();
            const w = parseFloat(match[2]);
            const item = data.find(d => d.id === id);
            if(item) {
                item.w = w;
                count++;
            }
        }
        save();
        render();
        closeAllModals();
        alert(`已批量更新 ${count} 个色号的库存`);
    }

    function copyLowStockText() {
        const el = document.getElementById('lowStockText');
        el.select();
        navigator.clipboard.writeText(el.value).then(() => alert("已复制到剪贴板"));
    }

    function openLowStockModal() {
        const lowList = data.filter(d => d.w < threshold);
        const listDiv = document.getElementById('lowStockList');
        listDiv.innerHTML = '';

        if (lowList.length === 0) {
            listDiv.innerHTML = `
                <div style="padding:30px 10px; text-align:center; color:#999;">
                    <div style="font-size:24px; margin-bottom:10px;">🎉</div>
                    <div style="font-size:13px;">当前库存充足</div>
                    <div style="font-size:11px; margin-top:5px;">暂无低于阈值 (${threshold}g) 的色号</div>
                </div>
            `;
            // 清空复制内容
            document.getElementById('lowStockText').value = '';
        } else {
            lowList.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; padding:12px; border-bottom:1px solid #f0f0f0; background:white;';
                
                row.innerHTML = `
                    <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; margin-right:12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="font-size:16px; color:#333;">${item.id}</b>
                            <span style="font-size:14px; font-weight:bold; color:#ff4d4f;">${item.w}g</span>
                        </div>
                        <div style="font-size:11px; color:#999; margin-top:2px;">库存不足 (阈值 ${threshold}g)</div>
                    </div>
                `;
                listDiv.appendChild(row);
            });
            
            // 去除最后一行边框
            if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';

            // 准备复制的文本内容
            const copyText = lowList.map(d => `${d.id}: ${d.w}g`).join('\n');
            document.getElementById('lowStockText').value = copyText;
        }

        showModal('lowStockModal');
    }

    // --- 水印功能 --- 新用户欢迎弹窗 ---
    function checkWelcome() {
        const hasVisited = localStorage.getItem('mard_visited');
        if (!hasVisited) {
            showModal('welcomeModal');
        }
    }

    function closeWelcomeModal() {
        localStorage.setItem('mard_visited', 'true');
        closeAllModals();
    }

    function showDevInfo() {
        showModal('devInfoModal');
    }

    // 启动时检查
    checkWelcome();

    render();
</script>
</body>
</html>