<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MARD è±†åº“ -æ‹¼è±†åº“å­˜ç®¡ç†å·¥å…·</title>
    <style>
        :root { --primary: #4a90e2; --warn: #ff4d4f; --bg: #f0f2f5; --success: #52c41a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; font-size: 14px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; padding-bottom: 90px; }
        


        /* å¤´éƒ¨æ§åˆ¶åŒº */
        .header-sticky { position: sticky; top: 0; background: white; z-index: 100; border-bottom: 2px solid #eee; padding: 12px 15px; }
        .top-bar { display: flex; flex-direction: column; margin-bottom: 10px; }
        .stats { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; 
            background: #f8f9fa; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            /* justify-items: center; text-align: center;  <-- Remove this to allow individual alignment */
        }
        .stats > div { display: flex; flex-direction: column; align-items: flex-start; width: 100%; }
        /* è®©ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆè‰²å·ï¼‰å·¦å¯¹é½ï¼Œå»é™¤äº†å·¦é—´è· */
        .stats > div:first-child { padding-left: 0; box-sizing: border-box; }
        /* è®©æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆè®¾ç½®ï¼‰ä¹Ÿå·¦å¯¹é½ï¼Œä¿ç•™å³é—´è· */
        .stats > div:last-child { padding-right: 8px; box-sizing: border-box; }
        .stat-item b { display: block; font-size: 16px; color: var(--primary); }

        /* é…ç½®ä¸æ’åºåŒº */
        .config-zone { font-size: 12px; background: #fffbe6; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .config-zone input { width: 40px; padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .btn-sort { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-sort.active { background: var(--primary); color: white; }

        .btn-text { font-size: 12px; color: var(--primary); cursor: pointer; background:none; border:none; padding:0; text-decoration: underline; }

        /* æœç´¢æ¡† */
        #search { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; margin-bottom: 5px; }
        
        /* åˆ—è¡¨æ¸²æŸ“ */
        .bead-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .bead-row.selected { background: #e6f7ff; }
        .col-select { width: 25px; }
        .col-color { width: 40px; }
        .swatch { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; }
        .col-id { width: 60px; font-weight: bold; font-family: monospace; font-size: 15px; }
        .col-weight { flex: 1; }
        .weight-badge { padding: 4px 8px; border-radius: 6px; background: #eee; font-weight: bold; font-family: monospace; cursor: pointer; }
        .weight-badge.low { background: var(--warn); color: white; }
        .col-action { width: 60px; text-align: right; }
        .btn-plus { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; padding: 5px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; }
        .btn-detail { background: #fff; border: 1px solid #d9d9d9; color: #666; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; margin-left: 5px; transition: all 0.2s; }
        .btn-detail:hover { color: var(--primary); border-color: var(--primary); }

        .info-tag { font-size: 10px; color: #999; display: block; margin-top: 3px; }
        .total-use { color: #8c8c8c; font-weight: bold; }

        /* åº•éƒ¨æ“ä½œæ  - æ‚¬æµ®å¡ç‰‡å¼è®¾è®¡ */
        .footer-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 32px); max-width: 568px; 
            background: rgba(33, 37, 41, 0.95); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            color: white; padding: 16px; 
            display: flex; flex-direction: column; gap: 12px; 
            box-sizing: border-box; z-index: 200; 
            border-radius: 24px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .footer-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .footer-info { font-size: 15px; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        
        .footer-btn-cancel {
            background: rgba(255, 255, 255, 0.15); border: none; color: rgba(255, 255, 255, 0.9);
            padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: background 0.2s;
        }
        .footer-btn-cancel:hover { background: rgba(255, 255, 255, 0.25); }

        .footer-actions { display: flex; gap: 10px; width: 100%; }

        .footer-btn-tool {
            flex: 1;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 12px;
            font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s; font-weight: 500;
        }
        .footer-btn-tool:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.15); }

        .btn-go { 
            background: linear-gradient(135deg, #52c41a, #389e0d); color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(82, 196, 26, 0.3); transition: transform 0.1s; font-size: 14px;
        }
        .btn-go:active { transform: scale(0.96); }

        /* å¼¹çª—æ ·å¼å‡çº§ */
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index:1000; transition: opacity 0.3s; }
        .modal { 
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
            background:white; padding:24px; border-radius:24px; 
            width: 85%; max-width: 360px; max-height: 70vh; overflow-y: auto; 
            z-index:1010; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop {
            0% { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .modal h3 { margin: 0 0 8px 0; text-align: center; font-size: 18px; color: #1f2937; }
        .modal-desc { text-align: center; color: #6b7280; font-size: 13px; margin-bottom: 24px; }
        
        .input-group { position: relative; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; }
        .input-group input {
            width: 100%; padding: 16px; 
            border: 2px solid transparent; 
            background: #f3f4f6;
            border-radius: 16px; 
            font-size: 28px; text-align: center; font-weight: 700; color: #111827; 
            outline: none; transition: all 0.2s;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        .input-group input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
        .input-suffix { position: absolute; right: 20px; color: #9ca3af; font-weight: 600; font-size: 16px; pointer-events: none; }

        .modal-btn-group { display: flex; flex-direction: column; gap: 12px; }
        .m-btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
        }
        .m-btn:active { transform: scale(0.98); }
        .m-btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(74, 144, 226, 0.3); }
        .m-btn-ghost { background: #f3f4f6; color: #4b5563; }
        
        .modal-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .modal-row:last-child { border-bottom: none; }
        .modal-input { width: 70px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; background: #f9fafb; font-weight: 600; }
        

        /* ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
        @media (max-width: 480px) {
            .container { padding-bottom: 80px; }
            .bead-row { padding: 8px 5px; }
            
            .col-select { width: 18px; }
            .col-color { width: 26px; padding-left: 6px; box-sizing: content-box; }
            .swatch { width: 20px; height: 20px; }
            .col-id { width: 38px; font-size: 12px; }
            .col-action { width: 42px; }
            
            .weight-badge { font-size: 12px; padding: 2px 6px; }
            .btn-plus { padding: 4px 4px; font-size: 10px; }
            /* æ¢å¤å·¦å¯¹é½ç¼©æ”¾ï¼Œå¹¶ç»™ä¸€ä¸ªå›ºå®šçš„å·¦è¾¹è·ï¼Œé¢„ç•™å‡ºå¤§æ¦‚1000gæ•°å­—çš„ç©ºé—´ */
            .btn-detail { padding: 0 4px; height: 18px; line-height: 16px; font-size: 12px; border-radius: 4px; margin-left: 2px; transform: scale(0.85); transform-origin: left center; white-space: nowrap; }
            
            /* åœ¨å°å±å¹•ä¸Šå‡å°é—´è· */
            .weight-primary-row { gap: 6px !important; }
            .weight-detail-row { gap: 4px !important; }
            .grain-info { display: none !important; } /* æå°å±å¹•éšè—ç²’æ•°ä¼°ç®—ï¼Œæˆ–ç¼©å° */
            
            /* å¤´éƒ¨ç§»åŠ¨ç«¯é€‚é… */
            .header-sticky { padding: 8px 10px; }
            /* è°ƒæ•´åˆ—å®½æ¯”ä¾‹ï¼Œç»™ç¬¬ä¸€åˆ—ï¼ˆè‰²å·ï¼‰æ›´å¤šç©ºé—´ */
            .stats { padding: 8px; gap: 5px !important; margin-right: 5px; grid-template-columns: 1.3fr 0.9fr 0.9fr 0.9fr !important; }
            .top-bar { margin-bottom: 5px; flex-wrap: wrap; row-gap: 8px; }
            .btn-text { font-size: 11px; }
            /* è°ƒæ•´ä¸‹æ‹‰æ¡†åœ¨ç§»åŠ¨ç«¯çš„å¤§å° */
            #seriesFilter { font-size: 13px !important; max-width: 100% !important; }
            
            /* å¯¼èˆªæ ç§»åŠ¨ç«¯é€‚é… */
            .nav-bar { display: flex !important; flex-wrap: nowrap !important; overflow-x: auto; padding: 6px 4px !important; justify-content: space-between !important; gap: 2px !important; }
            .nav-btn { padding: 4px 4px !important; font-size: 11px !important; white-space: nowrap; flex-shrink: 0; }
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
            .nav-bar::-webkit-scrollbar { display: none; }
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; align-items: center; 
            padding: 6px 10px; 
            margin-top: 5px;
            margin-bottom: 8px;
            background: #f8f9fa; 
            border-radius: 8px; 
        }
        /* å¯¼èˆªæ å¯¹é½ - ä¸Statsæ å¯¹é½ */
        .nav-bar > button:first-child { justify-self: start; padding-left: 8px; }
        .nav-bar > button:last-child { justify-self: end; padding-right: 8px; }
        .nav-bar > button:nth-child(2), .nav-bar > button:nth-child(3) { justify-self: center; }

        .nav-btn {
            display: flex; align-items: center; gap: 4px;
            background: transparent; border: 1px solid transparent; 
            cursor: pointer; padding: 4px 8px; border-radius: 15px;
            font-size: 12px; color: #666; transition: all 0.2s;
            white-space: nowrap; /* ç¡®ä¿æ–‡å­—ä¸æ¢è¡Œ */
        }
        .nav-btn:hover { background: #f0f7ff; border-color: #d6e4ff; color: #4a90e2; }

        /* ç»Ÿä¸€è¿”å›æŒ‰é’®æ ·å¼ */
        .btn-back {
            border: none;
            background: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: #555;
            flex-shrink: 0;
            padding: 0;
        }
        .btn-back:hover {
            background: #f8f9fa;
            transform: translateX(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            color: #333;
        }
        .btn-back:active {
            transform: scale(0.95);
        }

        /* ä¸­ç­‰å±å¹•æ˜¾ç¤ºç²’æ•° */
        @media (min-width: 360px) and (max-width: 480px) {
            .grain-info { display: inline !important; font-size: 9px !important; }
        }

    </style>
</head>
<body>

<div id="page-home" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
    <h1 style="color:#333; margin-bottom:40px; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Mardæ‹¼è±†å·¥å…·ç®±</h1>
    <div style="display:flex; flex-direction:column; gap:20px; width:80%; max-width:300px;">
        <button onclick="navTo('beads')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#4a90e2; box-shadow:0 10px 20px rgba(74, 144, 226, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">ğŸ¨</span> æ‹¼è±†åº“å­˜ç®¡ç†
        </button>
        <button onclick="navTo('fabric')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#eb2f96; box-shadow:0 10px 20px rgba(235, 47, 150, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">âœ‚ï¸</span> çƒ˜ç„™å¸ƒè£å‰ª
        </button>
        <div style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <input type="checkbox" id="defaultBeadsToggle" onchange="toggleDefaultPage()" style="transform: scale(1.2); cursor: pointer;">
            <label for="defaultBeadsToggle" style="color: #666; font-size: 14px; cursor: pointer;">ä¸‹æ¬¡é»˜è®¤è¿›å…¥æ‹¼è±†åº“å­˜</label>
        </div>

    </div>
    <div onclick="showDevInfo()" style="margin-top: 40px; color: #666; font-size: 12px; cursor: pointer; text-decoration: underline;">å¼€å‘è€…ä¿¡æ¯</div>
</div>

<div id="page-beads" style="display:none;">
<div class="container">

    <div class="header-sticky">
        <div style="display:flex; align-items:center; margin-bottom:10px;">
            <button onclick="navTo('home')" class="btn-back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <div class="nav-bar" style="flex:1; margin:0; margin-bottom:0;">
                <button class="nav-btn" onclick="showModal('helpModal')"><span>ğŸ“–</span><span>ä½¿ç”¨è¯´æ˜</span></button>
                <button class="nav-btn" onclick="openBatchInput()"><span>ğŸ“Š</span><span>åˆå§‹å½•å…¥</span></button>
                <button class="nav-btn" onclick="openDataModal('backup')"><span>âš™ï¸</span><span>æ•°æ®å¤‡ä»½</span></button>
            </div>
        </div>
        <div class="top-bar">
            <div class="stats">
                <div>
                    <span style="font-size:12px; color:#999; margin-bottom:2px; padding-left:5px;">è‰²å·</span>
                    <select id="seriesFilter" onchange="render()" style="font-size:14px; font-weight:bold; color:#333; border:none; background:transparent; outline:none; padding:0; cursor:pointer; font-family:inherit;">
                        <option value="221">Mard 221</option>
                        <option value="all">Mard å…¨ç³»åˆ—</option>
                    </select>
                </div>
                <div>
                    <span style="font-size:12px; color:#999; margin-bottom:2px;">è¡¥è´§</span>
                    <div style="display:flex; align-items:baseline; gap:5px;">
                        <b id="count-low" style="font-size:14px; color:var(--warn); line-height:1.2;">0</b>
                        <button class="btn-text" onclick="openLowStockModal()" style="font-size:12px; padding:0; text-decoration:underline; white-space:nowrap;">è¡¥è´§å•</button>
                    </div>
                </div>
                <div>
                    <span style="font-size:12px; color:#999; margin-bottom:2px;">é˜ˆå€¼</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <input type="number" id="threshold" value="5" onchange="updateThreshold()" style="width:35px; border:none; border-bottom:1px solid #999; text-align:center; color:#333; font-size:14px; font-weight:bold; padding:0; background:transparent;">
                        <span style="font-size:12px; color:#333;">g</span>
                    </div>
                </div>
                <div>
                    <span style="font-size:12px; color:#999; margin-bottom:2px;">è®¾ç½®</span>
                    <button class="btn-text" onclick="openIgnoredModal()" style="font-size:12px; padding:0; text-decoration:underline; white-space:nowrap; margin-top:2px; color:#4a90e2;">å¿½ç•¥æ¸…å•</button>
                </div>
            </div>
        </div>

        <input type="text" id="search" placeholder="è¾“å…¥è‰²å·æœç´¢..." oninput="render()">
        
        <div style="display:flex; align-items:center; padding:0px 0px; font-size:12px; color:#999; margin-top:5px;">
            <div style="width:5px;"></div>
            <div style="flex:1; display:flex; align-items:center;">
                 <span style="margin-right:5px;">æ’åºï¼š</span>
                 <select id="sortSelect" onchange="changeSortMode()" style="font-size:12px; color:#333; border:1px solid #eee; background:transparent; outline:none; padding:2px; border-radius:4px; cursor:pointer;">
                    <option value="id">æŒ‰è‰²å·æ’åº</option>
                    <option value="stock_desc">åº“å­˜ç”±å¤šåˆ°å°‘</option>
                    <option value="stock_asc">åº“å­˜ç”±å°‘åˆ°å¤š</option>
                    <option value="usage_desc">æ¶ˆè€—é‡ç”±å¤šåˆ°å°‘</option>
                    <option value="usage_asc">æ¶ˆè€—é‡ç”±å°‘åˆ°å¤š</option>
                    <option value="restock_desc">è¡¥è´§é‡ç”±å¤šåˆ°å°‘</option>
                    <option value="restock_asc">è¡¥è´§é‡ç”±å°‘åˆ°å¤š</option>
                 </select>
            </div>
            <div style="width:60px;"></div>
        </div>
    </div>

    <div id="grid"></div>
    <div style="text-align:center; padding:10px; color:#999; font-size:10px;">
        å¼€å‘è€…: å°çº¢ä¹¦ç”¨æˆ·ÄÅÄ“ï¼ŒID 11535779483ï¼Œä½¿ç”¨AIå·¥å…·å¼€å‘
    </div>
</div>

    <div id="footer" class="footer-bar" style="display:none;">
        <div class="footer-top">
            <div class="footer-info">
                <span>å·²é€‰ <b id="selNum" style="color:#ffd700; font-size:18px;">0</b> è‰²</span>
                <button onclick="cancelSelection()" class="footer-btn-cancel">å–æ¶ˆ</button>
            </div>
            <button class="btn-go" onclick="openConsumeModal()">å½•å…¥ç²’æ•°</button>
        </div>
        <div class="footer-actions">
             <button onclick="batchSetMonitor(true)" class="footer-btn-tool">
                <span>ğŸ””</span> å¼€å¯é˜ˆå€¼
             </button>
             <button onclick="batchSetMonitor(false)" class="footer-btn-tool">
                <span>ğŸ”•</span> å…³é—­é˜ˆå€¼
             </button>
        </div>
    </div>

</div> <!-- End page-beads -->

    <!-- å¼¹çª—éƒ¨åˆ† -->

<div class="overlay" id="mask" onclick="closeAllModals()"></div>
<div id="consumeModal" class="modal" style="width: 85%; max-width: 340px; padding: 20px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">æ¶ˆè€—å½•å…¥ (ç²’æ•°)</h3>
    <div id="modalList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 5px;"></div>
    <div class="modal-btn-group" style="gap: 10px;">
        <button class="m-btn m-btn-primary" onclick="submitConsume()" style="padding: 10px; font-size: 14px; border-radius: 10px;">ç¡®è®¤æ‰£é™¤</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 10px; font-size: 14px; border-radius: 10px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="editWeightModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 id="editWeightModalTitle" style="font-size: 18px; color: #333; margin-bottom: 25px;">ä¿®æ”¹åº“å­˜é‡é‡</h3>
    
    <div class="input-group" style="margin-bottom: 25px;">
        <input type="number" id="editWeightInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
        <span class="input-suffix" style="right: 30px; font-size: 16px; color: #999;">g</span>
    </div>
    
    <div class="modal-btn-group" style="gap: 12px;">
        <button class="m-btn m-btn-primary" onclick="submitEditWeight()" style="padding: 12px; font-size: 16px; border-radius: 12px; background: linear-gradient(135deg, #4a90e2, #357abd); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">ç¡®è®¤ä¿®æ”¹</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; color: #666;">å–æ¶ˆ</button>
    </div>
</div>

<div id="restockModal" class="modal">
    <h3>æ–°å¢è¡¥è´§</h3>
    <div class="modal-desc" id="restockTitle"></div>
    <div class="input-group">
        <input type="number" id="restockInput" placeholder="0" step="0.01">
        <span class="input-suffix">g</span>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRestock()">ç¡®è®¤è¡¥è´§</button>
        <button class="m-btn m-btn-ghost" onclick="showModal('editWeightModal')">è¿”å›</button>
    </div>
</div>

<div id="historyModal" class="modal" style="width:85%; max-width:340px;">
    <h3 id="historyTitle" style="font-size:16px; font-weight:bold; margin-bottom:12px;">åº“å­˜æ˜ç»†</h3>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f5f7fa; padding:10px; border-radius:10px;">
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">å½“å‰ä½™é‡</div>
            <div id="hist-stock" style="font-size:16px; font-weight:bold; color:#4a90e2;">0g</div>
        </div>
        <div style="text-align:center; border-left:1px solid #e0e0e0; border-right:1px solid #e0e0e0; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">æ€»æ¶ˆè€—</div>
            <div id="hist-used" style="font-size:16px; font-weight:bold; color:#ff4d4f;">0g</div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">æ€»è¡¥å……</div>
            <div id="hist-added" style="font-size:16px; font-weight:bold; color:#52c41a;">0g</div>
        </div>
    </div>

    <div style="max-height:240px; overflow-y:auto; border:1px solid #eee; border-radius:10px;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead style="background:#fafafa; position:sticky; top:0;">
                <tr>
                    <th style="padding:8px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">æ—¶é—´</th>
                    <th style="padding:8px; text-align:center; color:#999; font-weight:normal; border-bottom:1px solid #eee;">æ“ä½œ</th>
                    <th style="padding:8px; text-align:right; color:#999; font-weight:normal; border-bottom:1px solid #eee;">é‡é‡/ç²’æ•°</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>
    <div style="text-align:center; color:#ccc; font-size:10px; margin-top:5px;">
        æ³¨ï¼šæ€»è®¡æ•°æ®åŒ…å«å·²å½’æ¡£çš„å†å²è®°å½•ï¼Œå¯èƒ½å¤§äºä¸Šæ–¹åˆ—è¡¨æ˜¾ç¤ºçš„æœ€è¿‘20æ¡è®°å½•ä¹‹å’Œã€‚
    </div>

    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:8px; font-size:13px;">å…³é—­</button>
    </div>
</div>

<div id="helpModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">ä½¿ç”¨è¯´æ˜</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:13px; max-height:400px; overflow-y:auto; padding:0 5px;">
        <p style="margin-bottom:10px;"><b>1. åˆå§‹å½•å…¥ï¼š</b><br>ç‚¹å‡»â€œåˆå§‹å½•å…¥â€ï¼Œå¯æ‰¹é‡ç²˜è´´æ•°æ®ï¼ˆæ”¯æŒ A1 50 æˆ– JSON æ ¼å¼ï¼‰ï¼Œå¿«é€Ÿå»ºç«‹åº“å­˜ã€‚</p>
        <p style="margin-bottom:10px;"><b>2. æ¶ˆè€—ä¸è¡¥è´§ï¼š</b><br>â€¢ <b>æ¶ˆè€—</b>ï¼šé€‰ä¸­è‰²å· -> ç‚¹å‡»åº•éƒ¨â€œå½•å…¥ç²’æ•°â€ -> è¾“å…¥ç²’æ•°è‡ªåŠ¨æ‰£é™¤ï¼ŒæŒ‰1g=100ç²’è®¡ç®—ã€‚<br>â€¢ å¯ç›´æ¥ç‚¹å‡»æ•°å­—ä¿®æ”¹åº“å­˜é‡é‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®é‡é‡å˜åŒ–è®°å½•ä¸ºâ€œè¡¥è´§æˆ–æ¶ˆè€—â€ã€‚<br>â€¢ ä¹Ÿå¯ç‚¹å‡»+10gæŒ‰é’®å¿«é€Ÿè¡¥è´§ã€‚</p>
        <p style="margin-bottom:10px;"><b>3. é˜ˆå€¼æé†’ï¼š</b><br>åœ¨é¡¶éƒ¨è®¾ç½®é˜ˆå€¼ï¼ˆå¦‚5gï¼‰ï¼Œä½äºè¯¥å€¼çš„è‰²å·ä¼šæ˜¾ç¤ºçº¢è‰²èƒŒæ™¯ã€‚ç‚¹å‡»â€œè¡¥è´§å•â€å¯æŸ¥çœ‹æ‰€æœ‰ç¼ºè´§è‰²å·ã€‚</p>
        <p style="margin-bottom:10px;"><b>4. å¿½ç•¥æ¸…å•ï¼š</b><br>
        â€¢ è®¾ç½®æ–¹æ³•ï¼šé€‰ä¸­è‰²å·åï¼Œç‚¹å‡»åº•éƒ¨çš„ â€œğŸ”” å¼€å¯é˜ˆå€¼â€ æˆ– â€œğŸ”• å…³é—­é˜ˆå€¼â€ å³å¯æ‰¹é‡è®¾ç½®ã€‚<br>
        â€¢ å…³é—­é˜ˆå€¼çš„è‰²å·ï¼Œå³ä¾§ä¼šæ˜¾ç¤ºç°è‰² ğŸ”• å›¾æ ‡ï¼Œä¸æ˜¾ç¤ºçº¢è‰²ä½åº“å­˜è­¦å‘Šï¼Œä¹Ÿä¸è®¡å…¥â€œè¡¥è´§â€ç»Ÿè®¡ã€‚<br>
        â€¢ â€œè¡¥è´§â€ç»Ÿè®¡å’Œâ€œè¡¥è´§å•â€ä¼šè‡ªåŠ¨è¿‡æ»¤è¿™äº›è‰²å·ã€‚</p>
        <p style="margin-bottom:10px;"><b>5. å†å²è®°å½•ï¼š</b><br>ç‚¹å‡»â€œæŸ¥çœ‹æ˜ç»†â€æŒ‰é’®å¯æŸ¥çœ‹è‰²å·çš„åº“å­˜æ˜ç»†ï¼Œæ”¯æŒåˆ é™¤è®°å½•ï¼Œåˆ é™¤ååº“å­˜ä¼šè‡ªåŠ¨å›æ»šã€‚</p>
        <p style="margin-bottom:10px;"><b>6. æ•°æ®å¤‡ä»½ï¼š</b><br>ç‚¹å‡»â€œæ•°æ®å¤‡ä»½â€å¯å¯¼å‡ºåŒ…å«æ‰€æœ‰è®°å½•å’Œè®¾ç½®çš„å®Œæ•´å¤‡ä»½ã€‚æ›´æ¢è®¾å¤‡æ—¶ï¼Œåœ¨æ¢å¤é¡µé¢é€‰æ‹©è¯¥ CSV æ–‡ä»¶å³å¯æ— ç¼è¿ç§»ã€‚</p>
    </div>
    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()" style="padding:10px; font-size:14px;">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<div id="dataModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">æ•°æ®å¤‡ä»½</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px; background:#f5f7fa; padding:4px; border-radius:10px;">
        <button id="tabBackup" class="m-btn m-btn-ghost" style="flex:1; padding:8px; font-size:13px; border-radius:8px;" onclick="switchDataTab('backup')">å¤‡ä»½å¯¼å‡º</button>
        <button id="tabRestore" class="m-btn m-btn-ghost" style="flex:1; padding:8px; font-size:13px; border-radius:8px;" onclick="switchDataTab('restore')">æ¢å¤å¯¼å…¥</button>
    </div>
    
    <div id="viewBackup">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.5;">
                å°†å½“å‰æ‰€æœ‰è‰²å·åº“å­˜åŠæ“ä½œè®°å½•<br>å¯¼å‡ºä¸º CSV è¡¨æ ¼æ–‡ä»¶ã€‚
            </div>
            <button class="m-btn m-btn-primary" style="width: 100%; padding: 12px; font-size: 15px; background: #52c41a; border-color: #52c41a; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="downloadBackupFile()">
                <span>ğŸ“Š</span> å¯¼å‡º CSV è¡¨æ ¼
            </button>
        </div>
    </div>

    <div id="viewRestore" style="display:none;">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.5;">
                é€‰æ‹©ä¹‹å‰å¯¼å‡ºçš„ CSV å¤‡ä»½æ–‡ä»¶<br>ä»¥æ¢å¤åº“å­˜æ•°æ®ã€‚
            </div>
            <input type="file" id="restoreFile" style="display:none" onchange="loadBackupFile(this)">
            <button class="m-btn m-btn-primary" style="width: 100%; padding: 12px; font-size: 15px; background: #1890ff; border-color: #1890ff; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="document.getElementById('restoreFile').click()">
                <span>ğŸ“‚</span> é€‰æ‹©å¤‡ä»½æ–‡ä»¶
            </button>
            <textarea id="restoreInput" style="display:none;"></textarea>
        </div>
    </div>
    
    <div class="modal-btn-group" style="margin-top:10px;">
        <button class="m-btn m-btn-ghost" style="width: 100%; padding: 12px; font-size: 15px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="batchInputModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">åˆå§‹æ•°æ®æ‰¹é‡å½•å…¥</h3>
    <div class="modal-desc" style="margin-bottom:8px; text-align:left;">æ ¼å¼ï¼šè‰²å·+é‡é‡ (å¦‚ A1 50)</div>
    <textarea id="batchInputText" style="width:100%; height:150px; padding:10px; border:1px solid #eee; border-radius:10px; resize:none; font-family:monospace; font-size:13px; box-sizing:border-box; background:#fafafa; outline:none; color:#333;" placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼Œä¾‹å¦‚ï¼š&#10;A1 50&#10;B2: 20.5&#10;C3=100"></textarea>
    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="submitBatchInput()">å¼€å§‹è¯†åˆ«å¹¶å¯¼å…¥</button>
        <button class="m-btn m-btn-ghost" style="padding:8px; font-size:13px;" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="lowStockModal" class="modal" style="width:85%; max-width:340px; padding:20px; border-radius:24px;">
    <h3 style="font-size:18px; font-weight:bold; margin-bottom:20px; text-align:center; color:#333;">è¡¥è´§æ¸…å•</h3>
    <div id="lowStockHeader" style="margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:8px; border:1px solid #ffe58f; display:flex; align-items:center; gap:8px;">
        <span style="font-size:16px;">âš ï¸</span>
        <div class="modal-desc" style="font-size:12px; color:#d48806; margin:0; text-align:left;">
            <div>ä»¥ä¸‹è‰²å·åº“å­˜ä½äºè®¾å®šé˜ˆå€¼ï¼Œå»ºè®®åŠæ—¶è¡¥è´§ã€‚</div>
            <div style="margin-top:4px; opacity:0.8; font-size:11px; color:inherit;">(å·²æ ¹æ®é¦–é¡µâ€œè‰²å·â€ä¸‹æ‹‰æ¡†ç­›é€‰æ˜¾ç¤ºèŒƒå›´)</div>
        </div>
    </div>
    
    <div id="lowStockList" style="max-height:260px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px; margin-bottom:20px; padding:5px;"></div>
    
    <!-- éšè—çš„æ–‡æœ¬åŸŸç”¨äºå¤åˆ¶åŠŸèƒ½ -->
    <textarea id="lowStockText" style="position:absolute; left:-9999px;"></textarea>

    <div class="modal-btn-group" style="gap:10px;">
        <button class="m-btn m-btn-primary" style="padding:12px; font-size:15px; border-radius:12px;" onclick="copyLowStockText()">ä¸€é”®å¤åˆ¶æ¸…å•</button>
        <button class="m-btn m-btn-ghost" style="padding:12px; font-size:15px; border-radius:12px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="welcomeModal" class="modal">
    <h3>ğŸ“¢ æ¬¢è¿ä½¿ç”¨ MARD è±†åº“</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:14px; padding:0 10px;">
        <p style="margin-bottom:12px;"><b>1. æ•°æ®å®‰å…¨æé†’ï¼š</b><br>
        æœ¬å·¥å…·æ•°æ®<span style="color:#ff4d4f; font-weight:bold;">ä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ä¸­</span>ã€‚æ¸…ç†æµè§ˆå™¨ç¼“å­˜å°†å¯¼è‡´æ•°æ®æ°¸ä¹…ä¸¢å¤±ï¼<br>
        è¯·åŠ¡å¿…å®šæœŸå¤‡ä»½æ•°æ®ï¼ˆæ“ä½œå…¥å£ï¼šé¡µé¢ä¸Šæ–¹â€œæ•°æ®å¤‡ä»½â€ï¼‰ï¼Œä½œè€…ä¸æ‰¿æ‹…æ•°æ®ä¸¢å¤±çš„ä»»ä½•åæœã€‚</p>
        
        <p style="margin-bottom:12px;"><b>2. è®¾å¤‡åŒæ­¥ï¼š</b><br>
        æœ¬å·¥å…·ä¸ºç¦»çº¿ç½‘é¡µåº”ç”¨ï¼Œ<span style="color:#ff4d4f; font-weight:bold;">ä¸æ”¯æŒå¤šè®¾å¤‡å®æ—¶åŒæ­¥</span>ã€‚å¦‚éœ€åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨å¤‡ä»½/æ¢å¤åŠŸèƒ½æ‰‹åŠ¨è¿ç§»æ•°æ®ã€‚</p>
        
        <p style="margin-bottom:12px;"><b>3. åŠŸèƒ½è¯´æ˜ï¼š</b><br>
        è¯¦ç»†æ“ä½œæŒ‡å—è¯·ç‚¹å‡»é¡µé¢ä¸Šæ–¹çš„â€œğŸ“– ä½¿ç”¨è¯´æ˜â€æŸ¥çœ‹ã€‚</p>
    </div>
    <div class="modal-btn-group" style="margin-top:20px;">
        <button class="m-btn m-btn-primary" onclick="closeWelcomeModal()">æˆ‘å·²çŸ¥æ™“</button>
    </div>
</div>

<div id="ignoredModal" class="modal" style="width:85%; max-width:340px;">
    <h3>å·²å¿½ç•¥æé†’çš„è‰²å·</h3>
    <div class="modal-desc">ä»¥ä¸‹è‰²å·ä¸å‚ä¸ä½åº“å­˜é¢„è­¦</div>
    <div id="ignoredList" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:10px; margin-bottom:15px; padding:5px;"></div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="devInfoModal" class="modal" style="width:70%; max-width:260px; padding:15px;">
    <h3 style="font-size:16px;">å¼€å‘è€…ä¿¡æ¯</h3>
    <div style="text-align:center; padding:10px; color:#555; font-size:13px; line-height:1.6;">
        <p><b>å¼€å‘è€…:</b> å°çº¢ä¹¦ç”¨æˆ·ÄÅÄ“</p>
        <p><b>ID:</b> 11535779483</p>
        <p>ä½¿ç”¨ AI å·¥å…·å¼€å‘</p>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<!-- Fabric Tool Page -->
<div id="page-fabric" style="display:none; min-height:100vh; background:#f0f2f5;">
    <!-- Fabric Tool Header -->
    <div style="background:white; padding:12px 16px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); position:sticky; top:0; z-index:100;">
        <button onclick="navTo('home')" class="btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h2 style="margin:0; font-size:16px; flex:1;">çƒ˜ç„™å¸ƒè£å‰ªç»„åˆå·¥å…·</h2>
    </div>

    <div class="fabric-container">
        <!-- Sidebar -->
        <div class="fabric-sidebar">
            <h3 style="margin-top:0; font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">1. åŸå¸ƒå°ºå¯¸ (cm)</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div class="input-group-sm">
                    <label>é•¿</label>
                    <input type="number" id="canvasW" value="100" onchange="saveFabricState()">
                </div>
                <div class="input-group-sm">
                    <label>å®½</label>
                    <input type="number" id="canvasH" value="100" onchange="saveFabricState()">
                </div>
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                2. æˆå“è§„æ ¼ (æœ€å¤š5ç§)
                <button onclick="addSpec()" style="font-size:12px; background:#e6f7ff; color:#1890ff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">+ æ·»åŠ </button>
            </h3>
            <div style="font-size:12px; color:#999; margin-bottom:10px; line-height:1.4;">
                è§„æ ¼å‚è€ƒï¼šä¸€å—52é’‰æ¿è§„æ ¼ä¸º14*14cm, ä¸€å—78é’‰æ¿è§„æ ¼ä¸º14*21cm, ä¸€å—104é’‰æ¿è§„æ ¼ä¸º28*28cm
            </div>
            <div id="specList" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                <!-- Specs will be injected here -->
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">3. æ’åºåå¥½</h3>
            <select id="sortPref" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-bottom:20px; box-sizing:border-box;" onchange="saveFabricState()">
                <!-- Options will be dynamic -->
            </select>

            <button onclick="calculateLayout()" style="width:100%; padding:12px; background:linear-gradient(135deg, #eb2f96, #c41d7f); color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; box-shadow:0 4px 10px rgba(235, 47, 150, 0.3); box-sizing:border-box;">
                å¼€å§‹è®¡ç®—ï¼ˆä»…å±•ç¤ºåˆ©ç”¨ç‡â‰¥ 90%çš„æ–¹æ¡ˆ)
            </button>
            <div id="calcStatus" style="margin-top:10px; font-size:12px; color:#666; text-align:center;"></div>
        </div>

        <!-- Main Content -->
        <div class="fabric-main">
            <div id="solutionList" style="display:flex; flex-direction:column; gap:20px;">
                <div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:40px; margin-bottom:10px;">âœ‚ï¸</div>
                    <div class="desktop-hint">ç‚¹å‡»å·¦ä¾§â€œå¼€å§‹è®¡ç®—â€ç”Ÿæˆæ–¹æ¡ˆ</div>
                    <div class="mobile-hint">ç‚¹å‡»ä¸Šæ–¹â€œå¼€å§‹è®¡ç®—â€ç”Ÿæˆæ–¹æ¡ˆ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .input-group-sm { flex:1; display:flex; flex-direction:column; gap:4px; min-width:0; }
    .input-group-sm label { font-size:12px; color:#666; }
    .input-group-sm input { padding:6px; border:1px solid #ddd; border-radius:4px; width:100%; box-sizing:border-box; }
    
    .fabric-sidebar, .fabric-main { min-width: 300px; box-sizing: border-box; }
    @media (max-width: 600px) {
        .fabric-sidebar, .fabric-main { min-width: 100% !important; border-radius: 0 !important; box-shadow: none !important; padding: 16px !important; }
        .fabric-container { padding: 0 !important; gap: 10px !important; }
        .fabric-main { padding: 16px !important; background: transparent; }
    }
    
    .spec-item { display:flex; gap:8px; align-items:center; background:#f9fafb; padding:8px; border-radius:6px; }
    .spec-color { width:16px; height:16px; border-radius:4px; }
    .btn-del { border:none; background:none; color:#ff4d4f; cursor:pointer; font-size:16px; padding:0 4px; }

    .solution-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .sol-header { padding:12px 16px; background:#fafafa; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
    .sol-badge { background:#f6ffed; color:#52c41a; border:1px solid #b7eb8f; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold; white-space: nowrap; }
    .sol-body { padding:16px; display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; }
    .sol-canvas-wrapper { border:1px solid #eee; display:inline-block; position:relative; }
    .sol-info { flex:1; min-width:150px; }
    .sol-stat-row { display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#555; border-bottom:1px dotted #eee; padding-bottom:2px; }

    /* å“åº”å¼æç¤ºæ–‡å­— */
    .mobile-hint { display: none; }
    .desktop-hint { display: block; }

    /* Fabric Tool Layout */
    .fabric-container { max-width:1200px; margin:0 auto; padding:16px; display:flex; flex-wrap:wrap; gap:20px; }
    .fabric-sidebar { flex:1; min-width: 280px; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); height:fit-content; }
    .fabric-main { flex:2; min-width: 280px; }

    @media (max-width: 768px) {
        .mobile-hint { display: block; }
        .desktop-hint { display: none; }
    }

    @media (max-width: 600px) {
        .fabric-container { padding: 6px; gap: 12px; }
        .fabric-sidebar { padding: 16px; }
    }
</style>


<!-- Zoom Modal -->
<div id="zoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeZoom()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="margin-bottom:10px; font-weight:bold; font-size:18px; color:#333;" id="zoomTitle">æ–¹æ¡ˆè¯¦æƒ…</div>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:10px;">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <button id="zoomDownloadBtn" onclick="downloadSolution(currentZoomIdx)" style="margin-top:10px; padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">ä¿å­˜å›¾ç‰‡</button>
        <div id="zoomStats" style="margin-top:10px; width:100%; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; box-sizing: border-box; background: #fafafa;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center;">
             <button onclick="closeZoom()" style="padding:8px 20px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- Download Modal (Mobile) -->
<div id="downloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeDownloadModal()" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:5px;">
            <img id="downloadImg" style="max-width:100%; height:auto;" />
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
             <button id="downloadBtnMobile" style="padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">ä¿å­˜å›¾ç‰‡</button>
             <button onclick="closeDownloadModal()" style="padding:8px 20px; background:#1890ff; color:white; border:none; border-radius:6px; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<script>
    function navTo(page) {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-beads').style.display = 'none';
        document.getElementById('page-fabric').style.display = 'none';
        
        if (page === 'home') {
            document.getElementById('page-home').style.display = 'flex';
        } else if (page === 'beads') {
            document.getElementById('page-beads').style.display = 'block';
            checkWelcome();
        } else if (page === 'fabric') {
            document.getElementById('page-fabric').style.display = 'block';
            
            // Restore Fabric State
            const savedSpecs = localStorage.getItem('fabric_specs');
            if (savedSpecs) {
                specs = JSON.parse(savedSpecs);
                // Force update colors to match current theme (Fixes issue where Spec 3 might be purple)
                if (typeof specColors !== 'undefined') {
                    specs.forEach((s, i) => {
                        if (i < specColors.length) {
                            s.color = specColors[i];
                        }
                    });
                }
            }
            
            // If no specs (first time or cleared), add default
            if(specs.length === 0) {
                addSpec(); 
            } else {
                renderSpecs();
            }

            const savedW = localStorage.getItem('fabric_w');
            const savedH = localStorage.getItem('fabric_h');
            if (savedW) document.getElementById('canvasW').value = savedW;
            if (savedH) document.getElementById('canvasH').value = savedH;
            
            // Restore sort pref after specs are rendered (options need specs)
            setTimeout(() => {
                const savedSort = localStorage.getItem('fabric_sort');
                if (savedSort) {
                     const sortEl = document.getElementById('sortPref');
                     if(sortEl) sortEl.value = savedSort;
                }
                
                // Auto-calculate if data exists (User request: show last operation info)
                if (savedW && savedH && specs.length > 0) {
                    // Check if inputs are valid numbers
                    if (parseFloat(savedW) > 0 && parseFloat(savedH) > 0) {
                        // Check if all specs have valid dimensions
                        const allSpecsValid = specs.every(s => s.w > 0 && s.h > 0);
                        if (allSpecsValid) {
                             // Small delay to ensure UI is ready
                             calculateLayout();
                        }
                    }
                }
            }, 50);
        }
    }

    const MARD_DB = [
        {id:'A1',hex:'#faf5cd'},{id:'A2',hex:'#fcfed6'},{id:'A3',hex:'#fcff92'},{id:'A4',hex:'#f7ec5c'},{id:'A5',hex:'#f0d83a'},{id:'A6',hex:'#fda951'},{id:'A7',hex:'#fa8c4f'},{id:'A8',hex:'#fbda4d'},{id:'A9',hex:'#f79d5f'},{id:'A10',hex:'#f47e38'},{id:'A11',hex:'#fedb99'},{id:'A12',hex:'#fda276'},{id:'A13',hex:'#fec667'},{id:'A14',hex:'#f75842'},{id:'A15',hex:'#fbf65e'},{id:'A16',hex:'#feff97'},{id:'A17',hex:'#fde173'},{id:'A18',hex:'#fcbf80'},{id:'A19',hex:'#fd7e77'},{id:'A20',hex:'#f9d66e'},{id:'A21',hex:'#fae393'},{id:'A22',hex:'#edf878'},{id:'A23',hex:'#e4c8ba'},{id:'A24',hex:'#f3f6a9'},{id:'A25',hex:'#ffd785'},{id:'A26',hex:'#ffc734'},
        {id:'B1',hex:'#dff13b'},{id:'B2',hex:'#64f343'},{id:'B3',hex:'#a1f586'},{id:'B4',hex:'#5fdf34'},{id:'B5',hex:'#39e158'},{id:'B6',hex:'#64e0a4'},{id:'B7',hex:'#3eae7c'},{id:'B8',hex:'#1d9b54'},{id:'B9',hex:'#2a5037'},{id:'B10',hex:'#9ad1ba'},{id:'B11',hex:'#627032'},{id:'B12',hex:'#1a6e3d'},{id:'B13',hex:'#c8e87d'},{id:'B14',hex:'#abe84f'},{id:'B15',hex:'#305335'},{id:'B16',hex:'#c0ed9c'},{id:'B17',hex:'#9eb33e'},{id:'B18',hex:'#e6ed4f'},{id:'B19',hex:'#26b78e'},{id:'B20',hex:'#cbeccf'},{id:'B21',hex:'#18616a'},{id:'B22',hex:'#0a4241'},{id:'B23',hex:'#343b1a'},{id:'B24',hex:'#e8faa6'},{id:'B25',hex:'#4e846d'},{id:'B26',hex:'#907c35'},{id:'B27',hex:'#d0e0af'},{id:'B28',hex:'#9ee5bb'},{id:'B29',hex:'#c6df5f'},{id:'B30',hex:'#e3fbb1'},{id:'B31',hex:'#b4e691'},{id:'B32',hex:'#92ad60'},
        {id:'C1',hex:'#f0fee4'},{id:'C2',hex:'#abf8fe'},{id:'C3',hex:'#a2e0f7'},{id:'C4',hex:'#44cdfb'},{id:'C5',hex:'#06aadf'},{id:'C6',hex:'#54a7e9'},{id:'C7',hex:'#3977ca'},{id:'C8',hex:'#0f52bd'},{id:'C9',hex:'#3349c3'},{id:'C10',hex:'#3cbce3'},{id:'C11',hex:'#2aded3'},{id:'C12',hex:'#1e334e'},{id:'C13',hex:'#cde7fe'},{id:'C14',hex:'#d5fcf7'},{id:'C15',hex:'#21c5c4'},{id:'C16',hex:'#1858a2'},{id:'C17',hex:'#02d1f3'},{id:'C18',hex:'#213244'},{id:'C19',hex:'#18869d'},{id:'C20',hex:'#1a70a9'},{id:'C21',hex:'#bcddfc'},{id:'C22',hex:'#6bb1bb'},{id:'C23',hex:'#c8e2fd'},{id:'C24',hex:'#7ec5f9'},{id:'C25',hex:'#a9e8e0'},{id:'C26',hex:'#42adcf'},{id:'C27',hex:'#d0def9'},{id:'C28',hex:'#bdcee8'},{id:'C29',hex:'#364a89'},
        {id:'D1',hex:'#acb7ef'},{id:'D2',hex:'#868dd3'},{id:'D3',hex:'#3554af'},{id:'D4',hex:'#162d7b'},{id:'D5',hex:'#b34ec6'},{id:'D6',hex:'#b37bdc'},{id:'D7',hex:'#8758a9'},{id:'D8',hex:'#e3d2fe'},{id:'D9',hex:'#d5b9f4'},{id:'D10',hex:'#301a49'},{id:'D11',hex:'#beb9e2'},{id:'D12',hex:'#dc99ce'},{id:'D13',hex:'#b5038d'},{id:'D14',hex:'#862993'},{id:'D15',hex:'#2f1f8c'},{id:'D16',hex:'#e2e4f0'},{id:'D17',hex:'#c7d3f9'},{id:'D18',hex:'#9a64b8'},{id:'D19',hex:'#d8c2d9'},{id:'D20',hex:'#9a35ad'},{id:'D21',hex:'#940595'},{id:'D22',sweet:'#38389a'},{id:'D23',hex:'#eadbf8'},{id:'D24',hex:'#768ae1'},{id:'D25',hex:'#4950c2'},{id:'D26',hex:'#d6c6eb'},
        {id:'E1',hex:'#f6d4cb'},{id:'E2',hex:'#fcc1dd'},{id:'E3',hex:'#f6bde8'},{id:'E4',hex:'#e8649e'},{id:'E5',hex:'#f0569f'},{id:'E6',hex:'#eb4172'},{id:'E7',hex:'#c53674'},{id:'E8',hex:'#fddbe9'},{id:'E9',hex:'#e376c7'},{id:'E10',hex:'#d13b95'},{id:'E11',hex:'#f7dad4'},{id:'E12',hex:'#f693bf'},{id:'E13',hex:'#b5026a'},{id:'E14',hex:'#fad4bf'},{id:'E15',hex:'#f5c9ca'},{id:'E16',hex:'#fbf4ec'},{id:'E17',hex:'#f7e3ec'},{id:'E18',hex:'#f9c8db'},{id:'E19',hex:'#f6bbd1'},{id:'E20',hex:'#d7c6ce'},{id:'E21',hex:'#c09da4'},{id:'E22',hex:'#b38c9f'},{id:'E23',hex:'#937d8a'},{id:'E24',hex:'#debee5'},
        {id:'F1',hex:'#fe9381'},{id:'F2',hex:'#f63d4b'},{id:'F3',hex:'#ee4e3e'},{id:'F4',hex:'#fb2a40'},{id:'F5',hex:'#e10328'},{id:'F6',hex:'#913635'},{id:'F7',hex:'#911932'},{id:'F8',hex:'#bb0126'},{id:'F9',hex:'#e0677a'},{id:'F10',hex:'#874628'},{id:'F11',hex:'#592323'},{id:'F12',hex:'#f3536b'},{id:'F13',hex:'#f45c45'},{id:'F14',hex:'#fcadb2'},{id:'F15',hex:'#d50527'},{id:'F16',hex:'#f8c0a9'},{id:'F17',hex:'#e89b7d'},{id:'F18',hex:'#d07f4a'},{id:'F19',hex:'#be454a'},{id:'F20',hex:'#c69495'},{id:'F21',hex:'#f2b8c6'},{id:'F22',hex:'#f7c3d0'},{id:'F23',hex:'#ed806c'},{id:'F24',hex:'#e09daf'},{id:'F25',hex:'#e84854'},
        {id:'G1',hex:'#ffe4d3'},{id:'G2',hex:'#fcc6ac'},{id:'G3',hex:'#f1c4a5'},{id:'G4',hex:'#dcb387'},{id:'G5',hex:'#e7b34e'},{id:'G6',hex:'#e3a014'},{id:'G7',hex:'#985c3a'},{id:'G8',hex:'#713d2f'},{id:'G9',hex:'#e4b685'},{id:'G10',hex:'#da8c42'},{id:'G11',hex:'#dac898'},{id:'G12',hex:'#fec993'},{id:'G13',hex:'#b2714b'},{id:'G14',hex:'#8b684c'},{id:'G15',hex:'#f6f8e3'},{id:'G16',hex:'#f2d8c1'},{id:'G17',hex:'#77544e'},{id:'G18',hex:'#ffe3d5'},{id:'G19',hex:'#dd7d41'},{id:'G20',hex:'#a5452f'},{id:'G21',hex:'#b38561'},
        {id:'H1',hex:'#ffffff'},{id:'H2',hex:'#fbfbfb'},{id:'H3',hex:'#b4b4b4'},{id:'H4',hex:'#878787'},{id:'H5',hex:'#464646'},{id:'H6',hex:'#2c2c2c'},{id:'H7',hex:'#010101'},{id:'H8',hex:'#e7d6dc'},{id:'H9',hex:'#efedee'},{id:'H10',hex:'#ebebeb'},{id:'H11',hex:'#cdcdcd'},{id:'H12',hex:'#fdf6ee'},{id:'H13',hex:'#f4efd1'},{id:'H14',hex:'#ced7d4'},{id:'H15',hex:'#9aa6a6'},{id:'H16',hex:'#1b1213'},{id:'H17',hex:'#f0eeef'},{id:'H18',hex:'#fcfff6'},{id:'H19',hex:'#f2eee5'},{id:'H20',hex:'#96a09f'},{id:'H21',hex:'#f8fbe6'},{id:'H22',hex:'#cacad2'},{id:'H23',hex:'#9b9c94'},
        {id:'M1',hex:'#bbc6b6'},{id:'M2',hex:'#909994'},{id:'M3',hex:'#697e81'},{id:'M4',hex:'#e0d4bc'},{id:'M5',hex:'#d1ccaf'},{id:'M6',hex:'#b0aa86'},{id:'M7',hex:'#b0a796'},{id:'M8',hex:'#ae8082'},{id:'M9',hex:'#a68862'},{id:'M10',hex:'#c4b3bb'},{id:'M11',hex:'#9d7693'},{id:'M12',hex:'#644b51'},{id:'M13',hex:'#c79266'},{id:'M14',hex:'#c27563'},{id:'M15',hex:'#747d7a'},
        // Pç³»åˆ— (ç å…‰)
        {id:'P1',hex:'#F9F9F9'},{id:'P2',hex:'#ABABAB'},{id:'P3',hex:'#B6DBAF'},{id:'P4',hex:'#FEA2A3'},{id:'P5',hex:'#EB903F'},{id:'P6',hex:'#63CEA2'},{id:'P7',hex:'#E79273'},{id:'P8',hex:'#ECDB59'},{id:'P9',hex:'#DBD9DA'},{id:'P10',hex:'#DBC7EA'},{id:'P11',hex:'#F1E9D4'},{id:'P12',hex:'#E9EDEE'},{id:'P13',hex:'#ADCBF1'},{id:'P14',hex:'#337BAD'},{id:'P15',hex:'#668575'},{id:'P16',hex:'#FDC24E'},{id:'P17',hex:'#FDA42E'},{id:'P18',hex:'#FEBDA7'},{id:'P19',hex:'#FFDEE9'},{id:'P20',hex:'#FCBFD1'},{id:'P21',hex:'#E8BEC2'},{id:'P22',hex:'#DFAAA4'},{id:'P23',hex:'#A3656A'},
        // Qç³»åˆ— (æ¸©å˜)
        {id:'Q1',hex:'#F2A5E8'},{id:'Q2',hex:'#E9EC91'},{id:'Q3',hex:'#FFFF00'},{id:'Q4',hex:'#FFEBFA'},{id:'Q5',hex:'#76CEDE'},
        // Rç³»åˆ— (é€æ˜æœå†»æ°´æ™¶)
        {id:'R1',hex:'#D40E1F'},{id:'R2',hex:'#F13484'},{id:'R3',hex:'#FB852B'},{id:'R4',hex:'#F8ED33'},{id:'R5',hex:'#32C958'},{id:'R6',hex:'#1EBA93'},{id:'R7',hex:'#1D779C'},{id:'R8',hex:'#1960C8'},{id:'R9',hex:'#945AB1'},{id:'R10',hex:'#F8DA54'},{id:'R11',hex:'#FCECF7'},{id:'R12',hex:'#D8D4D3'},{id:'R13',hex:'#56534E'},{id:'R14',hex:'#A3E7DC'},{id:'R15',hex:'#78CEE7'},{id:'R16',hex:'#3FCDCE'},{id:'R17',hex:'#4E8379'},{id:'R18',hex:'#7DCA9C'},{id:'R19',hex:'#C8E664'},{id:'R20',hex:'#E3CCBA'},{id:'R21',hex:'#A17140'},{id:'R22',hex:'#6B372C'},{id:'R23',hex:'#F6BB6F'},{id:'R24',hex:'#F3C6C0'},{id:'R25',hex:'#C76A62'},{id:'R26',hex:'#D093BC'},{id:'R27',hex:'#E58EAE'},{id:'R28',hex:'#9F85CF'},
        // Tç³»åˆ— (é€æ˜)
        {id:'T1',hex:'#FCFDFF'},
        // Yç³»åˆ— (å¤œå…‰)
        {id:'Y1',hex:'#FF6FB7'},{id:'Y2',hex:'#FDB583'},{id:'Y3',hex:'#D8FCA4'},{id:'Y4',hex:'#91DAFB'},{id:'Y5',hex:'#E987EA'},{id:'Y6',hex:'#F7D4B8'},{id:'Y7',hex:'#F1FA7D'},{id:'Y8',hex:'#5EE88C'},{id:'Y9',hex:'#F8F5FE'},
        // ZGç³»åˆ— (å…‰å˜)
        {id:'ZG1',hex:'#DAABB3'},{id:'ZG2',hex:'#D6AA87'},{id:'ZG3',hex:'#C1BD8D'},{id:'ZG4',hex:'#96B69F'},{id:'ZG5',hex:'#849DC6'},{id:'ZG6',hex:'#94BFE2'},{id:'ZG7',hex:'#E2A9D2'},{id:'ZG8',hex:'#AB91C0'}
    ];

    let data = JSON.parse(localStorage.getItem('bead_v_sort')) || MARD_DB.map(i => ({...i, w: 0, totalUsed: 0, logs: [], monitor: true}));
    
    // åŒæ­¥æ–°è‰²å·ï¼šæ£€æŸ¥ MARD_DB ä¸­æ˜¯å¦æœ‰æ–°è‰²å·æœªåœ¨ data ä¸­
    MARD_DB.forEach(dbItem => {
        let existing = data.find(d => d.id === dbItem.id);
        if (!existing) {
            data.push({...dbItem, w: 0, totalUsed: 0, logs: [], monitor: true});
        } else {
            // ç¡®ä¿æ—§æ•°æ®ä¹Ÿæœ‰ monitor å­—æ®µ
            if(existing.monitor === undefined) existing.monitor = true;
        }
    });

    let threshold = parseFloat(localStorage.getItem('bead_threshold')) || 5;
    document.getElementById('threshold').value = threshold; // ä¿®å¤é˜ˆå€¼å›æ˜¾
    let currentSortMode = 'id'; // æ’åºæ¨¡å¼çŠ¶æ€
    let sel = new Set();
    let currentEditId = null;

    function formatTime(now) {
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}:${s}`;
    }

    let collapsedSeries = new Set();

    function toggleSeries(key) {
        if(collapsedSeries.has(key)) collapsedSeries.delete(key);
        else collapsedSeries.add(key);
        render();
    }

    function createRow(item) {
        const isMonitored = item.monitor !== false;
        const isLow = isMonitored && (item.w < threshold);
        const grainCount = Math.round(item.w * 100);
        
        // è®¡ç®—æ€»è¡¥è´§
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
             totalAdded = item.totalAdded;
        } else {
            // å…¼å®¹é€»è¾‘ï¼šä» logs è®¡ç®—å¹¶åˆå§‹åŒ–
            if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type === 'add') totalAdded += (log.val || 0);
                 });
            }
            totalAdded = parseFloat(totalAdded.toFixed(2));
            // åˆå§‹åŒ–å­—æ®µä»¥ä¾¿åç»­ç´¯åŠ 
            item.totalAdded = totalAdded; 
        }
        
        // è®¡ç®—æ€»æ¶ˆè€—
        let totalUsed = 0;
        if (item.totalUsed !== undefined) {
             totalUsed = item.totalUsed;
        } else {
             // å…¼å®¹é€»è¾‘ï¼šä» logs è®¡ç®—å¹¶åˆå§‹åŒ–
             if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type !== 'add') {
                         const count = log.c || log.val || 0;
                         const g = parseFloat((count / 100).toFixed(2));
                         totalUsed += g;
                     }
                 });
             }
             totalUsed = parseFloat(totalUsed.toFixed(2));
             item.totalUsed = totalUsed; 
        }
        const monitorIcon = !isMonitored ? '<span style="font-size:12px; margin-left:2px; opacity:0.5;">ğŸ”•</span>' : '';

        const row = document.createElement('div');
        row.className = `bead-row ${sel.has(item.id) ? 'selected' : ''}`;
        row.onclick = () => toggleSelect(item.id);
        
        row.innerHTML = `
            <div class="col-select"><input type="checkbox" ${sel.has(item.id)?'checked':''}></div>
            <div class="col-color"><div class="swatch" style="background:${item.hex}"></div></div>
            <div class="col-id" style="display:flex; align-items:center;">${item.id}${monitorIcon}</div>
            <div class="col-weight" style="display:flex; flex-direction:column; justify-content:center; gap:2px;">
                <div class="weight-primary-row" style="display:flex; align-items:center; gap:15px;">
                    <div style="cursor:pointer; display:flex; align-items:baseline;" onclick="event.stopPropagation(); manualEdit('${item.id}')">
                        <span class="weight-badge ${isLow ? 'low' : ''}">${item.w}g</span>
                        <span class="grain-info" style="font-size:10px; color:#999; margin-left:4px;">â‰ˆ${grainCount}ç²’</span>
                    </div>
                </div>
                <div class="weight-detail-row" style="font-size:10px; color:#999; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                     <span style="white-space:nowrap;">æ€»è€—: <b style="color:#ff4d4f; font-weight:normal;">${totalUsed}g</b></span>
                     <span style="white-space:nowrap;">æ€»è¡¥: <b style="color:#52c41a; font-weight:normal;">${totalAdded}g</b></span>
                     <button class="btn-detail" onclick="event.stopPropagation(); openHistory('${item.id}')">æŸ¥çœ‹æ˜ç»†</button>
                </div>
            </div>
            <div class="col-action">
                <button class="btn-plus" onclick="event.stopPropagation(); quickAdd('${item.id}')">+10g</button>
            </div>
        `;
        return row;
    }

    function render() {
        const q = document.getElementById('search').value.toUpperCase();
        
        // è·å–å½“å‰ç³»åˆ—ç­›é€‰çŠ¶æ€
        let seriesMode = document.getElementById('seriesFilter').value;
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('bead_series_filter', seriesMode);

        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // ç³»åˆ—ç­›é€‰é€»è¾‘
        let displayData = data.filter(item => {
            if (seriesMode === 'all') return true;
            // Mard 221 æ¨¡å¼ä¸‹æ’é™¤ P, Q, R, T, Y, ZG ç³»åˆ—
            const match = item.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';
            const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
            return !extraSeries.includes(series);
        });
        
        // æ’åºé€»è¾‘
        if (currentSortMode === 'usage_desc') {
            displayData.sort((a, b) => (b.totalUsed || 0) - (a.totalUsed || 0));
        } else if (currentSortMode === 'usage_asc') {
            displayData.sort((a, b) => (a.totalUsed || 0) - (b.totalUsed || 0));
        } else if (currentSortMode === 'stock_desc') {
            displayData.sort((a, b) => b.w - a.w); // é™åº
        } else if (currentSortMode === 'stock_asc') {
            displayData.sort((a, b) => a.w - b.w); // å‡åº
        } else if (currentSortMode.startsWith('restock')) {
             displayData.sort((a, b) => {
                 const getRestock = (item) => {
                     if(!item.logs) return 0;
                     return item.logs.reduce((sum, log) => sum + (log.type === 'add' ? (log.val||0) : 0), 0);
                 };
                 const valA = getRestock(a);
                 const valB = getRestock(b);
                 return currentSortMode === 'restock_desc' ? valB - valA : valA - valB;
             });
        } else {
            // é»˜è®¤æŒ‰IDå­—æ¯+æ•°å­—æ’åº
            displayData.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true, sensitivity: 'base'}));
        }

        // è®¡ç®—ä½åº“å­˜æ•°é‡ï¼ˆåŸºäºå½“å‰æœç´¢è¿‡æ»¤ï¼‰
        let lowCount = 0;
        displayData.forEach(item => {
            if (item.id.includes(q)) {
                if(item.monitor !== false && item.w < threshold) lowCount++;
            }
        });
        document.getElementById('count-low').innerText = lowCount;

        // åˆ†ç»„æ˜¾ç¤ºé€»è¾‘ï¼ˆä»…åœ¨é»˜è®¤æ’åºä¸”æ— æœç´¢æ—¶å¯ç”¨ï¼‰
        if (currentSortMode === 'id' && q === '') {
             const groups = {};
             displayData.forEach(item => {
                 // æå–ç³»åˆ—å‰ç¼€ (æ”¯æŒ ZG è¿™ç§åŒå­—æ¯ç³»åˆ—)
                 const match = item.id.match(/^[A-Z]+/);
                 let key = match ? match[0] : '#';
                 if(!groups[key]) groups[key] = [];
                 groups[key].push(item);
             });
             
             const seriesNames = {
                'P': 'ç å…‰',
                'Q': 'æ¸©å˜',
                'R': 'é€æ˜æœå†»æ°´æ™¶',
                'T': 'é€æ˜',
                'Y': 'å¤œå…‰',
                'ZG': 'å…‰å˜'
             };

             Object.keys(groups).sort().forEach(series => {
                 const items = groups[series];
                 const isCollapsed = collapsedSeries.has(series);
                 const seriesDesc = seriesNames[series] ? ` (${seriesNames[series]})` : '';
                 
                 const header = document.createElement('div');
                 header.onclick = () => toggleSeries(series);
                 header.style.cssText = 'background:#f8f9fa; padding:10px 15px; font-weight:bold; color:#555; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center;';
                 header.innerHTML = `
                    <span>${series}ç³»åˆ—${seriesDesc} (${items.length})</span>
                    <span style="transform:${isCollapsed?'rotate(-90deg)':'rotate(0deg)'}; transition:transform 0.2s; display:flex; align-items:center;">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="#999" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </span>
                 `;
                 grid.appendChild(header);
                 
                 if(!isCollapsed) {
                     items.forEach(item => {
                         grid.appendChild(createRow(item));
                     });
                 }
             });
        } else {
             // æ‰å¹³åˆ—è¡¨æ¨¡å¼
             displayData.forEach(item => {
                 if (item.id.includes(q)) {
                     grid.appendChild(createRow(item));
                 }
             });
        }
        
        save();
    }

    function changeSortMode() {
        currentSortMode = document.getElementById('sortSelect').value;
        render();
    }

    function toggleSelect(id) {
        sel.has(id) ? sel.delete(id) : sel.add(id);
        updateFooter();
        render();
    }
    
    function cancelSelection() {
        sel.clear();
        updateFooter();
        render();
    }

    function batchSetMonitor(enable) {
        if (sel.size === 0) return;
        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            if(item) item.monitor = enable;
        });
        save();
        cancelSelection();
        alert(enable ? "å·²å¼€å¯é€‰ä¸­è‰²å·çš„é˜ˆå€¼æé†’" : "å·²å…³é—­é€‰ä¸­è‰²å·çš„é˜ˆå€¼æé†’");
    }
    
    function updateFooter() {
        document.getElementById('footer').style.display = sel.size > 0 ? 'flex' : 'none';
        document.getElementById('selNum').innerText = sel.size;
    }

    function updateThreshold() {
        threshold = parseFloat(document.getElementById('threshold').value) || 0;
        localStorage.setItem('bead_threshold', threshold);
        render();
    }

    function quickAdd(id) {
        const item = data.find(d => d.id === id);
        const addVal = 10;
        item.w = parseFloat((item.w + addVal).toFixed(2));
        // ç»´æŠ¤æ€»è¡¥è´§é‡
        item.totalAdded = parseFloat(((item.totalAdded || 0) + addVal).toFixed(2));
        
        // è®°å½•è¡¥è´§æ—¥å¿—
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: addVal });
        if(item.logs.length > 20) item.logs.shift(); // å¢åŠ æ—¥å¿—ä¿ç•™æ¡æ•°
        
        save(); // å¢åŠ ä¿å­˜
        render();
    }

    function manualEdit(id) {
        currentEditId = id;
        const item = data.find(d => d.id === id);
        document.getElementById('editWeightModalTitle').innerText = `ä¿®æ”¹åº“å­˜é‡é‡ ${id}`;
        const input = document.getElementById('editWeightInput');
        input.value = item.w;
        showModal('editWeightModal');
        setTimeout(() => input.select(), 50);
        
        // ç»‘å®šå›è½¦äº‹ä»¶
        input.onkeydown = function(e) {
            if(e.key === 'Enter') submitEditWeight();
        }
    }

    function openRestockModal() {
        if(!currentEditId) return;
        document.getElementById('restockTitle').innerText = `æ­£åœ¨ä¸ºè‰²å· [${currentEditId}] è¡¥è´§`;
        document.getElementById('restockInput').value = '';
        showModal('restockModal');
        setTimeout(() => document.getElementById('restockInput').focus(), 50);
        
        document.getElementById('restockInput').onkeydown = function(e) {
            if(e.key === 'Enter') submitRestock();
        }
    }

    function submitRestock() {
        const val = parseFloat(document.getElementById('restockInput').value);
        if(!currentEditId || isNaN(val) || val <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è¡¥è´§é‡é‡");
            return;
        }
        
        const item = data.find(d => d.id === currentEditId);
        item.w = parseFloat((item.w + val).toFixed(2));
        // ç»´æŠ¤æ€»è¡¥è´§é‡
        item.totalAdded = parseFloat(((item.totalAdded || 0) + val).toFixed(2));
        
        // è®°å½•æ—¥å¿—
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: val });
        if(item.logs.length > 20) item.logs.shift();
        
        save();
        render();
        closeAllModals();
        alert(`å·²æˆåŠŸè¡¥è´§ ${val}g`);
    }

    function openHistory(id) {
        const item = data.find(d => d.id === id);
        if(!item) return; // å®¹é”™å¤„ç†

        // 1. è®¾ç½®æ ‡é¢˜å’Œæ¦‚è§ˆæ•°æ®
        document.getElementById('historyTitle').innerHTML = `è‰²å· ${id} æ˜ç»†`;
        document.getElementById('hist-stock').innerText = (item.w || 0) + 'g';
        document.getElementById('hist-used').innerText = (item.totalUsed || 0) + 'g';
        
        // è®¡ç®—æ€»è¡¥å……ï¼šä¼˜å…ˆä½¿ç”¨æŒä¹…åŒ–å­—æ®µ
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
            totalAdded = item.totalAdded;
        } else {
            if(item.logs) {
                item.logs.forEach(log => {
                    if(log.type === 'add') {
                        totalAdded += (log.val || 0);
                    }
                });
            }
        }
        document.getElementById('hist-added').innerText = parseFloat(totalAdded.toFixed(2)) + 'g';

        // è®¡ç®—æ€»æ¶ˆè€—
        let totalUsed = 0;
        if (item.totalUsed !== undefined) {
             totalUsed = item.totalUsed;
        } else {
             if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type !== 'add') {
                         const count = log.c || log.val || 0;
                         const g = parseFloat((count / 100).toFixed(2));
                         totalUsed += g;
                     }
                 });
             }
        }
        document.getElementById('hist-used').innerText = parseFloat(totalUsed.toFixed(2)) + 'g';

        // 2. æ¸²æŸ“è®°å½•è¡¨æ ¼
        const tbody = document.getElementById('historyList');
        tbody.innerHTML = '';
        
        if (item.logs && item.logs.length > 0) {
            // ç»™æ—¥å¿—åŠ ä¸ŠåŸå§‹ç´¢å¼•ï¼Œæ–¹ä¾¿åˆ é™¤
            const logsWithIdx = item.logs.map((log, idx) => ({...log, idx}));
            
            // å€’åºæ˜¾ç¤º
            logsWithIdx.reverse().forEach(log => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f0f0f0';
                
                // --- æ—¶é—´åˆ— ---
                const tdTime = document.createElement('td');
                tdTime.style.padding = '10px';
                tdTime.style.color = '#666';
                tdTime.innerText = log.d;
                tr.appendChild(tdTime);
                
                // --- æ“ä½œç±»å‹åˆ— ---
                const tdType = document.createElement('td');
                tdType.style.padding = '10px';
                tdType.style.textAlign = 'center';
                
                let typeText = '';
                let typeColor = '#333';
                
                if (log.type === 'add') {
                    typeText = 'è¡¥è´§';
                    typeColor = '#52c41a'; // ç»¿è‰²
                } else {
                    typeText = 'æ¶ˆè€—';
                    typeColor = '#ff4d4f'; // çº¢è‰²
                }
                
                tdType.innerHTML = `<span style="background:${typeColor}15; color:${typeColor}; padding:2px 6px; border-radius:4px; font-size:11px;">${typeText}</span>`;
                tr.appendChild(tdType);
                
                // --- é‡é‡/ç²’æ•°åŠåˆ é™¤åˆ— ---
                const tdVal = document.createElement('td');
                tdVal.style.padding = '10px';
                tdVal.style.textAlign = 'right';
                
                let valHtml = '';
                if (log.type === 'add') {
                    valHtml = `<span style="color:#333;">+${log.val}g</span>`;
                } else {
                    const count = log.c || log.val || 0;
                    const weight = (count / 100).toFixed(2);
                    // å¦‚æœæ˜¯æ‰‹åŠ¨è°ƒæ•´ä¸”æ²¡æœ‰å…·ä½“ç²’æ•°è®°å½•ï¼ˆæ—§æ•°æ®å…¼å®¹ï¼‰ï¼Œä¼˜å…ˆæ˜¾ç¤ºé‡é‡
                    if (log.isManual) {
                         valHtml = `<span style="color:#333;">-${weight}g</span>`;
                    } else {
                         valHtml = `<span style="color:#333;">${count}ç²’</span><br><span style="font-size:10px; color:#999;">â‰ˆ ${weight}g</span>`;
                    }
                }
                
                // åˆ é™¤æŒ‰é’®
                const delBtn = `<button onclick="deleteLog('${id}', ${log.idx})" style="margin-left:8px; border:none; background:none; color:#999; cursor:pointer; font-size:16px; padding:0;">Ã—</button>`;
                
                tdVal.innerHTML = `<div style="display:flex; align-items:center; justify-content:flex-end;"><div>${valHtml}</div>${delBtn}</div>`;
                tr.appendChild(tdVal);
                
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="3" style="padding:20px; text-align:center; color:#999;">æš‚æ— è®°å½•</td>';
            tbody.appendChild(tr);
        }
        
        showModal('historyModal');
    }

    function deleteLog(id, logIdx) {
        if(!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\nåˆ é™¤åå°†è‡ªåŠ¨å›æ»šåº“å­˜å˜åŒ–ã€‚")) return;
        
        const item = data.find(d => d.id === id);
        if(!item || !item.logs || !item.logs[logIdx]) return;
        
        const log = item.logs[logIdx];
        
        if (log.type === 'add') {
            // å›æ»šè¡¥è´§ï¼šå‡å°‘åº“å­˜
            item.w = Math.max(0, parseFloat((item.w - log.val).toFixed(2)));
            // å›æ»šæ€»è¡¥è´§
            item.totalAdded = Math.max(0, parseFloat(((item.totalAdded || 0) - log.val).toFixed(2)));
        } else {
            // å›æ»šæ¶ˆè€—ï¼šå¢åŠ åº“å­˜ï¼Œå‡å°‘ç´¯è®¡æ¶ˆè€—
            const count = log.c || log.val || 0;
            const g = parseFloat((count / 100).toFixed(2));
            item.w = parseFloat((item.w + g).toFixed(2));
            item.totalUsed = Math.max(0, parseFloat((item.totalUsed - g).toFixed(2)));
        }
        
        // åˆ é™¤è®°å½•
        item.logs.splice(logIdx, 1);
        
        save();
        render();
        // é‡æ–°æ¸²æŸ“å½“å‰æ‰“å¼€çš„å†å²å¼¹çª—
        openHistory(id);
    }

    function submitEditWeight() {
        if(!currentEditId) return;
        const input = document.getElementById('editWeightInput');
        const val = parseFloat(input.value);
        
        // ä¿æŒåŸæœ‰é€»è¾‘ï¼šè¾“å…¥æ— æ•ˆæ•°å­—åˆ™è§†ä¸º0
        const finalVal = (!isNaN(val) && val >= 0) ? val : 0;
        
        const item = data.find(d => d.id === currentEditId);
        if(item) {
            const oldVal = item.w;
            const diff = finalVal - oldVal;
            
            // æ›´æ–°åº“å­˜
            item.w = parseFloat(finalVal.toFixed(2));
            
            // è‡ªåŠ¨è®°å½•æ—¥å¿— (å¿½ç•¥æå°å·®å¼‚)
            if (Math.abs(diff) > 0.001) {
                const now = new Date();
                const dateStr = formatTime(now);
                if(!item.logs) item.logs = [];
                
                if (diff > 0) {
                    const addedVal = parseFloat(diff.toFixed(2));
                    // å¢åŠ åº“å­˜ -> è§†ä¸ºè¡¥è´§
                    item.logs.push({ d: dateStr, type: 'add', val: addedVal, isManual: true });
                    // ç»´æŠ¤æ€»è¡¥è´§é‡
                    item.totalAdded = parseFloat(((item.totalAdded || 0) + addedVal).toFixed(2));
                } else {
                    // å‡å°‘åº“å­˜ -> è§†ä¸ºæ¶ˆè€—
                    const loss = -diff;
                    // æ›´æ–°ç´¯è®¡æ¶ˆè€—
                    item.totalUsed = parseFloat(((item.totalUsed || 0) + loss).toFixed(2));
                    // è®°å½•ä¸ºæ¶ˆè€— (æŠ˜ç®—ä¸ºç²’æ•°ï¼Œå‡è®¾ 1g = 100 ç²’)
                    item.logs.push({ d: dateStr, c: Math.round(loss * 100), isManual: true });
                }
                
                if(item.logs.length > 20) item.logs.shift();
            }
            
            render();
        }
        
        closeAllModals();
        currentEditId = null;
        input.onkeydown = null;
    }

    function openConsumeModal() {
        const listDiv = document.getElementById('modalList');
        listDiv.innerHTML = '';
        
        if (sel.size === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">æœªé€‰æ‹©ä»»ä½•è‰²å·</div>';
            showModal('consumeModal');
            return;
        }

        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            const currentStockGrains = Math.round(item.w * 100); // å½“å‰åº“å­˜ç²’æ•°
            
            const row = document.createElement('div');
            row.className = 'modal-row';
            // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼è¦†ç›–é»˜è®¤ modal-row
            row.style.cssText = 'display:flex; flex-direction:column; padding: 12px; border-bottom: 1px solid #f0f0f0; background:white; align-items: stretch;';
            
            row.innerHTML = `
                <div style="display:flex; align-items:center; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap: 12px;">
                        <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                        <div style="display:flex; flex-direction:column;">
                            <b style="font-size:16px; color:#333;">${id}</b>
                            <span style="font-size:11px; color:#999;">åº“å­˜: ${currentStockGrains}ç²’</span>
                        </div>
                    </div>
                    <div style="position:relative;">
                        <input type="number" class="consume-input" data-id="${id}" data-stock="${currentStockGrains}" placeholder="0" oninput="checkConsumeLimit(this)" 
                               style="width: 70px; padding: 8px 5px; border: 1px solid #e0e0e0; border-radius: 8px; text-align: center; font-size: 16px; font-weight:bold; color:#333; outline:none; background:#f9fafb; transition: all 0.2s;">
                    </div>
                </div>
                <div class="limit-warn" id="warn-${id}" style="width:100%; color:#ff4d4f; font-size:11px; margin-top:8px; display:none; text-align:right; background:#fff1f0; padding:4px 8px; border-radius:4px;">
                     âš ï¸ æ¶ˆè€—é‡è¶…è¿‡åº“å­˜ (${currentStockGrains})
                </div>
            `;
            listDiv.appendChild(row);
        });
        
        // å»é™¤æœ€åä¸€è¡Œè¾¹æ¡†
        if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';
        
        showModal('consumeModal');
        
        // è‡ªåŠ¨èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
        setTimeout(() => {
            const firstInput = listDiv.querySelector('input');
            if(firstInput) firstInput.focus();
        }, 100);
    }

    function checkConsumeLimit(input) {
        const val = parseFloat(input.value) || 0;
        const stock = parseFloat(input.getAttribute('data-stock'));
        const id = input.getAttribute('data-id');
        const warnEl = document.getElementById(`warn-${id}`);
        
        if (val > stock) {
            warnEl.style.display = 'block';
        } else {
            warnEl.style.display = 'none';
        }
    }

    function submitConsume() {
        const inputs = document.querySelectorAll('.consume-input');
        const now = new Date();
        const dateStr = formatTime(now);
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            const count = parseFloat(input.value) || 0;
            if(count > 0) {
                const item = data.find(d => d.id === id);
                const g = count / 100;
                item.w = Math.max(0, parseFloat((item.w - g).toFixed(2)));
                item.totalUsed = parseFloat(((item.totalUsed || 0) + g).toFixed(2));
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, c: count });
                if(item.logs.length > 10) item.logs.shift();
            }
        });
        closeAllModals();
        sel.clear();
        document.getElementById('footer').style.display = 'none';
        render();
    }

    function showModal(id) {
        document.getElementById('mask').style.display = 'block';
        document.getElementById(id).style.display = 'block';
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(el => el.style.display = 'none');
        document.getElementById('mask').style.display = 'none';
    }

    // å…¼å®¹æ—§å‡½æ•°è°ƒç”¨ï¼Œé˜²æ­¢é—æ¼
    function closeModal() { closeAllModals(); }

    function save() { localStorage.setItem('bead_v_sort', JSON.stringify(data)); }

    // --- æ•°æ®ç®¡ç†åŠŸèƒ½ ---
    function openDataModal(tab) {
        showModal('dataModal');
        switchDataTab(tab);
        // Clean up previous inputs
        if(tab !== 'backup') {
            document.getElementById('restoreInput').value = '';
        }
    }

    function switchDataTab(tab) {
        document.getElementById('tabBackup').className = tab==='backup' ? 'm-btn m-btn-primary' : 'm-btn m-btn-ghost';
        document.getElementById('tabRestore').className = tab==='restore' ? 'm-btn m-btn-primary' : 'm-btn m-btn-ghost';
        document.getElementById('viewBackup').style.display = tab==='backup' ? 'block' : 'none';
        document.getElementById('viewRestore').style.display = tab==='restore' ? 'block' : 'none';
    }

    function execRestore() {
        let content = document.getElementById('restoreInput').value;
        if (!content) return;
        
        if(!confirm("è­¦å‘Šï¼šæ¢å¤æ“ä½œå°†é‡ç½®å½“å‰æ‰€æœ‰åº“å­˜æ•°æ®ï¼Œç„¶åå¯¼å…¥æ–°æ•°æ®ã€‚\nç¡®è®¤ç»§ç»­å—ï¼Ÿ")) return;

        // ç§»é™¤å¯èƒ½çš„ BOM
        if (content.charCodeAt(0) === 0xFEFF) {
            content = content.slice(1);
        }
        content = content.trim();

        let jsonStr = content;

        // æ£€æµ‹æ˜¯å¦ä¸º CSV å•å…ƒæ ¼å°è£…æ ¼å¼ (ä»¥å¼•å·å¼€å¤´å’Œç»“å°¾)
        if (content.startsWith('"') && content.endsWith('"')) {
            // ç§»é™¤é¦–å°¾å¼•å·
            let inner = content.substring(1, content.length - 1);
            // è¿˜åŸè½¬ä¹‰çš„å¼•å· ("" -> ")
            jsonStr = inner.replace(/""/g, '"');
        }

        try {
            const backupData = JSON.parse(jsonStr);
            let restoreItems = [];
            let newThreshold = null;

            // å…¼å®¹ç›´æ¥çš„æ•°ç»„æ ¼å¼ (æ—§ç‰ˆ JSON) æˆ–æ–°çš„å¯¹è±¡æ ¼å¼
            if (Array.isArray(backupData)) {
                restoreItems = backupData;
            } else if (backupData.items && Array.isArray(backupData.items)) {
                restoreItems = backupData.items;
                if (backupData.threshold) newThreshold = backupData.threshold;
            } else if (backupData.data && Array.isArray(backupData.data)) {
                 // å…¼å®¹ä¹‹å‰å°è¯•è¿‡çš„ JSON ç»“æ„ { data: [...] }
                 restoreItems = backupData.data;
                 if (backupData.config && backupData.config.threshold) newThreshold = backupData.config.threshold;
            } else {
                throw new Error("æ— æ•ˆçš„æ•°æ®æ ¼å¼");
            }

            // æ„å»ºå¿«é€ŸæŸ¥æ‰¾è¡¨
            const backupMap = new Map(restoreItems.map(i => [i.id, i]));
            let restoreCount = 0;

            // æ›´æ–°ç°æœ‰æ•°æ®
            data.forEach(item => {
                if (backupMap.has(item.id)) {
                    const backupItem = backupMap.get(item.id);
                    item.w = backupItem.w !== undefined ? backupItem.w : 0;
                    item.monitor = backupItem.monitor !== undefined ? backupItem.monitor : true;
                    item.logs = backupItem.logs || [];
                    item.totalAdded = backupItem.totalAdded || 0;
                    item.totalUsed = backupItem.totalUsed || 0;
                    restoreCount++;
                } else {
                    // å¦‚æœå¤‡ä»½ä¸­æ²¡æœ‰è¯¥è‰²å·ï¼Œé‡ç½®ä¸ºåˆå§‹çŠ¶æ€
                    item.w = 0;
                    item.monitor = true;
                    item.logs = [];
                    item.totalAdded = 0;
                    item.totalUsed = 0;
                }
            });

            // æ¢å¤é˜ˆå€¼é…ç½®
            if (newThreshold !== null) {
                threshold = parseFloat(newThreshold);
                localStorage.setItem('bead_threshold', threshold);
                document.getElementById('threshold').value = threshold;
            }

            save();
            render();
            closeAllModals();
            alert(`å·²æˆåŠŸæ¢å¤ ${restoreCount} ä¸ªè‰²å·çš„æ•°æ®ã€‚`);

        } catch (e) {
            console.error(e);
            alert("æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message);
        }
    }

    function downloadBackupFile() {
        // æ„å»ºå®Œæ•´çš„å¤‡ä»½å¯¹è±¡
        const backupObj = {
            version: "2.0",
            timestamp: new Date().toISOString(),
            threshold: threshold,
            items: data
        };

        const jsonStr = JSON.stringify(backupObj);
        
        // CSV è½¬ä¹‰è§„åˆ™ï¼šåŒå¼•å·è½¬ä¸ºä¸¤ä¸ªåŒå¼•å·ï¼Œæ•´ä¸ªå†…å®¹ç”¨åŒå¼•å·åŒ…è£¹
        // è¿™æ ·æ•´ä¸ª JSON å°±å˜æˆäº† CSV çš„ç¬¬ä¸€ä¸ªå•å…ƒæ ¼
        const csvCell = '"' + jsonStr.replace(/"/g, '""') + '"';
        
        // æ·»åŠ  BOM ä»¥é˜²æ­¢ä¹±ç 
        const csvContent = '\uFEFF' + csvCell;
        
        const fileName = `Mard_Inventory_Backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`;
        
        // Strategy 1: HTML5+ (App)
        if (window.plus && window.plus.io) {
             plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, function(fs) {
                fs.root.getFile(fileName, {create: true, exclusive: false}, function(fileEntry) {
                    fileEntry.createWriter(function(writer) {
                        writer.onwrite = function() {
                            alert(`å¤‡ä»½æ–‡ä»¶å·²å¯¼å‡ºè‡³æ‰‹æœºã€ä¸‹è½½/Downloadã€‘æ–‡ä»¶å¤¹:\n${fileEntry.fullPath}\næ³¨æ„ï¼šæ­¤ CSV ä»…åŒ…å«å•æ ¼ JSON æ•°æ®ã€‚`);
                        };
                        writer.onerror = function(e) {
                             alert("ä¿å­˜å¤±è´¥: " + e.message);
                        };
                        writer.write(csvContent);
                    }, function(e){ alert("åˆ›å»ºå†™å…¥å™¨å¤±è´¥: " + e.message); });
                }, function(e){ alert("åˆ›å»ºæ–‡ä»¶å¤±è´¥: " + e.message); });
            }, function(e) {
                 // Fallback to Private Doc
                 plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
                    fs.root.getFile(fileName, {create: true}, function(fileEntry) {
                         fileEntry.createWriter(function(writer) {
                             writer.onwrite = function() {
                                 alert(`å·²ä¿å­˜è‡³ç§æœ‰æ–‡æ¡£:\n${fileEntry.fullPath}`);
                             };
                             writer.write(csvContent);
                         });
                    });
                 }, function(e2) { alert("æ— æ³•è®¿é—®å­˜å‚¨: " + e2.message); });
            });
            return;
        }

        // Strategy 2: Web Standard
        try {
            const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
        } catch(e) {
            alert("å¯¼å‡ºå¤±è´¥: " + e.message);
        }
    }

    function loadBackupFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store content in hidden textarea for execRestore logic
                document.getElementById('restoreInput').value = e.target.result;
                // Immediately ask to restore
                execRestore();
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    // --- æ‰¹é‡åˆå§‹å½•å…¥åŠŸèƒ½ ---
    function openBatchInput() {
        document.getElementById('batchInputText').value = '';
        showModal('batchInputModal');
    }

    function submitBatchInput() {
        const text = document.getElementById('batchInputText').value;
        const regex = /([A-Z]+[0-9]+)[^0-9\.]*(\d+(\.\d+)?)/gi;
        let match;
        let count = 0;
        while ((match = regex.exec(text)) !== null) {
            const id = match[1].toUpperCase();
            const w = parseFloat(match[2]);
            const item = data.find(d => d.id === id);
            if(item) {
                item.w = w;
                count++;
            }
        }
        save();
        render();
        closeAllModals();
        alert(`å·²æ‰¹é‡æ›´æ–° ${count} ä¸ªè‰²å·çš„åº“å­˜`);
    }

    function copyLowStockText() {
        const el = document.getElementById('lowStockText');
        el.select();
        navigator.clipboard.writeText(el.value).then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
    }

    function openIgnoredModal() {
        const list = data.filter(d => d.monitor === false);
        const container = document.getElementById('ignoredList');
        container.innerHTML = '';
        
        if(list.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">å½“å‰æ²¡æœ‰å¿½ç•¥ä»»ä½•è‰²å·</div>';
        } else {
            list.forEach(item => {
                const row = document.createElement('div');
                row.className = 'modal-row';
                row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #f0f0f0; gap: 10px;';
                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; flex: 1; overflow: hidden;">
                        <div class="swatch" style="width:24px; height:24px; background:${item.hex}; border-radius:50%; border:1px solid #eee; flex-shrink: 0;"></div>
                        <span style="font-weight:bold; font-family:monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.id}</span>
                    </div>
                    <button onclick="restoreMonitor('${item.id}')" style="background:#fff; border:1px solid #ccc; color:#333; padding:6px 12px; border-radius:4px; font-size:13px; cursor:pointer; flex-shrink:0;">æ¢å¤æé†’</button>
                `;
                container.appendChild(row);
            });
        }
        showModal('ignoredModal');
    }

    function restoreMonitor(id) {
        const item = data.find(d => d.id === id);
        if(item) {
            item.monitor = true;
            save();
            render();
            openIgnoredModal(); // åˆ·æ–°åˆ—è¡¨
        }
    }

    function openLowStockModal() {
        // è·å–å½“å‰ç­›é€‰æ¨¡å¼
        const seriesMode = document.getElementById('seriesFilter').value;
        
        // ç­›é€‰é€»è¾‘ä¸ render ä¿æŒä¸€è‡´
        const lowList = data.filter(d => {
            // 1. ç›‘æ§å¼€å¯ä¸”ä½äºé˜ˆå€¼
            if (d.monitor === false || d.w >= threshold) return false;
            
            // 2. ç³»åˆ—ç­›é€‰
            if (seriesMode === 'all') return true;
            // Mard 221 æ¨¡å¼ä¸‹æ’é™¤ P, Q, R, T, Y ç³»åˆ—
            const match = d.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';
            const extraSeries = ['P', 'Q', 'R', 'T', 'Y'];
            return !extraSeries.includes(series);
        });

        const listDiv = document.getElementById('lowStockList');
        const headerDiv = document.getElementById('lowStockHeader');
        listDiv.innerHTML = '';

        if (lowList.length === 0) {
            headerDiv.style.display = 'none';
            listDiv.innerHTML = `
                <div style="padding:30px 10px; text-align:center; color:#999;">
                    <div style="font-size:24px; margin-bottom:10px;">ğŸ‰</div>
                    <div style="font-size:13px;">å½“å‰åº“å­˜å……è¶³</div>
                    <div style="font-size:11px; margin-top:5px;">æš‚æ— ä½äºé˜ˆå€¼ (${threshold}g) çš„è‰²å·</div>
                </div>
            `;
            // æ¸…ç©ºå¤åˆ¶å†…å®¹
            document.getElementById('lowStockText').value = '';
        } else {
            headerDiv.style.display = 'flex';
            lowList.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; padding:12px; border-bottom:1px solid #f0f0f0; background:white;';
                
                row.innerHTML = `
                    <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; margin-right:12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="font-size:16px; color:#333;">${item.id}</b>
                            <span style="font-size:14px; font-weight:bold; color:#ff4d4f;">${item.w}g</span>
                        </div>
                        <div style="font-size:11px; color:#999; margin-top:2px;">åº“å­˜ä¸è¶³ (é˜ˆå€¼ ${threshold}g)</div>
                    </div>
                `;
                listDiv.appendChild(row);
            });
            
            // å»é™¤æœ€åä¸€è¡Œè¾¹æ¡†
            if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';

            // å‡†å¤‡å¤åˆ¶çš„æ–‡æœ¬å†…å®¹
            const copyText = lowList.map(d => `${d.id}: ${d.w}g`).join('\n');
            document.getElementById('lowStockText').value = copyText;
        }

        showModal('lowStockModal');
    }

    // --- æ°´å°åŠŸèƒ½ --- æ–°ç”¨æˆ·æ¬¢è¿å¼¹çª— ---
    function checkWelcome() {
        const hasVisited = localStorage.getItem('mard_visited');
        if (!hasVisited) {
            showModal('welcomeModal');
        }
    }

    function closeWelcomeModal() {
        localStorage.setItem('mard_visited', 'true');
        closeAllModals();
    }

    function showDevInfo() {
        showModal('devInfoModal');
    }

    // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„ç³»åˆ—
    const savedSeries = localStorage.getItem('bead_series_filter');
    if (savedSeries) {
        document.getElementById('seriesFilter').value = savedSeries;
    }

    // å¯åŠ¨æ—¶æ£€æŸ¥
    // checkWelcome(); // Moved to navTo
    
    // Check default page preference
    const defaultBeads = localStorage.getItem('default_page_beads');
    if (defaultBeads === 'true') {
        document.getElementById('defaultBeadsToggle').checked = true;
        navTo('beads');
    } else {
        navTo('home');
    }

    render();

    // --- Fabric Tool Logic ---

    function toggleDefaultPage() {
        const isChecked = document.getElementById('defaultBeadsToggle').checked;
        if (isChecked) {
            localStorage.setItem('default_page_beads', 'true');
        } else {
            localStorage.removeItem('default_page_beads');
        }
    }
    let specs = [];
    const specColors = ['#f5dce0', '#dcedc8', '#fdf6c6', '#adc6ff', '#d3adf7']; // Pink, Green, Yellow, Blue, Purple

    function addSpec() {
        if (specs.length >= 5) {
            alert("æœ€å¤šæ·»åŠ  5 ç§è§„æ ¼");
            return;
        }
        specs.push({ w: '', h: '', color: specColors[specs.length] });
        saveFabricState();
        renderSpecs();
    }

    function removeSpec(index) {
        specs.splice(index, 1);
        saveFabricState();
        renderSpecs();
    }

    function updateSpec(index, field, val) {
        // Only allow integers
        const intVal = parseInt(val);
        if (isNaN(intVal)) {
            specs[index][field] = '';
        } else {
            specs[index][field] = intVal;
        }
        saveFabricState();
        renderSpecs();
    }

    function renderSpecs() {
        const list = document.getElementById('specList');
        list.innerHTML = '';
        specs.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'spec-item';
            div.innerHTML = `
                <div class="spec-color" style="background:${s.color}"></div>
                <div style="font-size:12px; font-weight:bold; color:#666;">#${i+1}</div>
                <div style="position:relative; flex:1;">
                    <input type="number" value="${s.w}" placeholder="é•¿" onchange="updateSpec(${i}, 'w', this.value)" style="width:100%; padding:4px; padding-right:20px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box;">
                    <span style="position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:10px; color:#999; pointer-events:none;">cm</span>
                </div>
                <span style="font-size:12px; color:#999;">x</span>
                <div style="position:relative; flex:1;">
                    <input type="number" value="${s.h}" placeholder="å®½" onchange="updateSpec(${i}, 'h', this.value)" style="width:100%; padding:4px; padding-right:20px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box;">
                    <span style="position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:10px; color:#999; pointer-events:none;">cm</span>
                </div>
                <button class="btn-del" onclick="removeSpec(${i})">Ã—</button>
            `;
            list.appendChild(div);
        });
        updateSortOptions();
    }

    function updateSortOptions() {
        const select = document.getElementById('sortPref');
        if (!select) return;
        const currentVal = select.value;
        
        select.innerHTML = '';
        
        // Define options
        const opts = [
            {v:'all_specs', t:'ä¼˜å…ˆåŒ…å«å…¨éƒ¨è§„æ ¼æ–¹æ¡ˆ'},
            {v:'efficiency', t:'åˆ©ç”¨ç‡ä»é«˜åˆ°ä½'}
        ];
        
        // Add dynamic spec options
        specs.forEach((s, i) => {
            opts.push({v:`spec${i+1}`, t:`è§„æ ¼${i+1}æ•°é‡ä¼˜å…ˆ`});
        });
        
        opts.forEach(o => {
            const el = document.createElement('option');
            el.value = o.v;
            el.innerText = o.t;
            select.appendChild(el);
        });
        
        // Restore selection or default to all_specs
        const exists = opts.some(o => o.v === currentVal);
        if (exists) select.value = currentVal;
        else select.value = 'all_specs';
    }

    function saveFabricState() {
        const W = document.getElementById('canvasW').value;
        const H = document.getElementById('canvasH').value;
        const sort = document.getElementById('sortPref').value;
        
        localStorage.setItem('fabric_w', W);
        localStorage.setItem('fabric_h', H);
        localStorage.setItem('fabric_sort', sort);
        localStorage.setItem('fabric_specs', JSON.stringify(specs));
    }

    let currentRenderedSolutions = [];
    let currentFabricW = 0;
    let currentFabricH = 0;

    // --- Algorithm ---
    function calculateLayout() {
        saveFabricState(); // Save state on calculation trigger
        const W = parseFloat(document.getElementById('canvasW').value);
        const H = parseFloat(document.getElementById('canvasH').value);
        
        currentFabricW = W;
        currentFabricH = H;

        const sortPref = document.getElementById('sortPref').value;
        const statusEl = document.getElementById('calcStatus');
        const listEl = document.getElementById('solutionList');

        if (!W || !H || specs.length === 0) {
            alert("è¯·å®Œå–„å°ºå¯¸ä¿¡æ¯");
            return;
        }
        
        statusEl.innerText = "è®¡ç®—ä¸­...";
        listEl.innerHTML = ''; 

        // 1. Generate Combinations (Recursion)
        const targetArea = 0.9 * W * H;
        const totalArea = W * H;
        let solutions = [];
        
        // Determine target spec index for priority search
        let targetSpecIndex = -1;
        if (sortPref.startsWith('spec')) {
            targetSpecIndex = parseInt(sortPref.replace('spec', '')) - 1;
        }

        function search(index, currentCounts, currentArea) {
            if (currentArea > totalArea) return;
            
            if (index === specs.length) {
                if (currentArea >= targetArea) {
                    solutions.push({ counts: [...currentCounts], area: currentArea, utilization: currentArea / totalArea });
                }
                return;
            }

            const s = specs[index];
            const sArea = s.w * s.h;
            // Limit max count to avoid infinite loops if size is small
            const maxCnt = Math.min(200, Math.floor((totalArea - currentArea) / sArea));
            
            // Determine iteration order
            // Default: Descending (Max -> 0) to prefer filling space with current spec
            // If targetSpecIndex is set:
            //   - index < targetSpecIndex: Ascending (0 -> Max) to save space for target
            //   - index >= targetSpecIndex: Descending (Max -> 0) to fill space with target and others
            
            let start, end, step;
            let useDescending = true;
            
            if (targetSpecIndex !== -1 && index < targetSpecIndex) {
                useDescending = false;
            }
            
            if (useDescending) {
                start = maxCnt; end = 0; step = -1;
            } else {
                start = 0; end = maxCnt; step = 1;
            }

            for (let c = start; (step > 0 ? c <= end : c >= end); c += step) {
                currentCounts[index] = c;
                search(index + 1, currentCounts, currentArea + c * sArea);
                if (solutions.length > 10000) return; 
            }
        }
        
        search(0, new Array(specs.length).fill(0), 0);

        if (solutions.length === 0) {
            statusEl.innerText = "æ— æ»¡è¶³ >=90% åˆ©ç”¨ç‡çš„æ–¹æ¡ˆ";
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æœªæ‰¾åˆ°é«˜åˆ©ç”¨ç‡æ–¹æ¡ˆï¼Œå»ºè®®æ·»åŠ å¡«å……ä»¶</div>';
            return;
        }

        // 2. Validate Packing
        let validSolutions = [];
        solutions.sort((a, b) => b.utilization - a.utilization);
        const toCheck = solutions; 
        
        const packStrategies = [
            (a, b) => Math.max(b.w, b.h) - Math.max(a.w, a.h), // Max side desc (default)
            (a, b) => (b.w * b.h) - (a.w * a.h),             // Area desc
            (a, b) => Math.min(b.w, b.h) - Math.min(a.w, a.h), // Min side desc
            (a, b) => b.w - a.w                                // Width desc
        ];

        for (let sol of toCheck) {
            let items = [];
            sol.counts.forEach((cnt, i) => {
                for(let k=0; k<cnt; k++) items.push({ ...specs[i], id: i });
            });
            
            let bestResult = null;
            
            // Try different packing heuristics to find a fit
            // Combinations of Sort Strategy + Split Strategy (Horizontal/Vertical)
            for (let sortFn of packStrategies) {
                // Try Horizontal Split first (default)
                let result = packItems(W, H, items, sortFn, false);
                if (result) {
                    bestResult = result;
                    break; 
                }
                // Try Vertical Split
                result = packItems(W, H, items, sortFn, true);
                if (result) {
                    bestResult = result;
                    break;
                }
            }
            
            if (bestResult) {
                // Try to fill leftovers (Iterative greedy fill)
                // If we find any spec that fits in the leftovers, add it and re-pack
                let addedAny = false;
                let safetyLimit = 0;
                
                do {
                    addedAny = false;
                    safetyLimit++;
                    if (safetyLimit > 50) break; // Prevent infinite loop
                    
                    let bestExtra = null;
                    let maxExtraArea = 0;
                    
                    // Look for best fitting item across all leftovers
                    for (let l of bestResult.leftovers) {
                        for (let sIdx = 0; sIdx < specs.length; sIdx++) {
                            const s = specs[sIdx];
                            // Check fit (normal and rotated)
                            let fits = (s.w <= l.w && s.h <= l.h) || (s.h <= l.w && s.w <= l.h);
                            if (fits) {
                                const area = s.w * s.h;
                                if (area > maxExtraArea) {
                                    maxExtraArea = area;
                                    bestExtra = { s: s, id: sIdx };
                                }
                            }
                        }
                    }
                    
                    if (bestExtra) {
                        // Add extra item
                        items.push({ ...bestExtra.s, id: bestExtra.id });
                        sol.counts[bestExtra.id]++;
                        
                        // Re-pack with new item set
                        // We must find a valid packing for the new set
                        let improvedResult = null;
                        for (let sortFn of packStrategies) {
                             let res = packItems(W, H, items, sortFn, false); 
                             if (res) { improvedResult = res; break; }
                             res = packItems(W, H, items, sortFn, true); 
                             if (res) { improvedResult = res; break; }
                        }
                        
                        if (improvedResult) {
                            bestResult = improvedResult;
                            addedAny = true;
                            // Update solution stats
                            sol.area += bestExtra.s.w * bestExtra.s.h;
                            sol.utilization = sol.area / totalArea;
                        } else {
                            // Backtrack if failed (should be rare if space exists, but packing is heuristic)
                            items.pop();
                            sol.counts[bestExtra.id]--;
                            addedAny = false; 
                        }
                    }
                } while (addedAny);

                sol.placements = bestResult.placements;
                sol.leftovers = bestResult.leftovers;
                validSolutions.push(sol);
            }
        }

        // 3. Sort Results
        if (sortPref === 'all_specs') {
             validSolutions.sort((a, b) => {
                 const aHasAll = a.counts.every(c => c > 0);
                 const bHasAll = b.counts.every(c => c > 0);
                 if (aHasAll !== bHasAll) return bHasAll ? 1 : -1;
                 return b.utilization - a.utilization;
             });
        } else if (sortPref === 'variety') {
             // Priority: Number of different specs (variety) desc -> Utilization desc
             validSolutions.sort((a, b) => {
                 const varietyA = a.counts.filter(c => c > 0).length;
                 const varietyB = b.counts.filter(c => c > 0).length;
                 if (varietyA !== varietyB) {
                     return varietyB - varietyA; // More variety first
                 }
                 return b.utilization - a.utilization; // Then higher utilization
             });
        } else if (sortPref === 'efficiency') {
            validSolutions.sort((a, b) => b.utilization - a.utilization);
        } else if (sortPref.startsWith('spec')) {
            const specIdx = parseInt(sortPref.replace('spec', '')) - 1;
            validSolutions.sort((a, b) => {
                const countA = a.counts[specIdx] || 0;
                const countB = b.counts[specIdx] || 0;
                return countB - countA;
            });
        }
        
        // Deduplicate solutions based on physical dimensions (user request)
        // Check if generated solution spec dimensions have completely identical combinations
        const uniqueSolutions = [];
        const seenSignatures = new Set();
        
        validSolutions.forEach(sol => {
            // Build signature: sorted list of dimensions "WxH"
            let dims = [];
            sol.counts.forEach((cnt, i) => {
                for(let k=0; k<cnt; k++) {
                    dims.push(`${specs[i].w}x${specs[i].h}`);
                }
            });
            dims.sort();
            const sig = dims.join('|');
            
            if (!seenSignatures.has(sig)) {
                seenSignatures.add(sig);
                uniqueSolutions.push(sol);
            }
        });
        validSolutions = uniqueSolutions;

        // 4. Render All Valid Solutions
        const totalFound = validSolutions.length;
        if (validSolutions.length > 50) {
            validSolutions = validSolutions.slice(0, 50);
        }
        
        currentRenderedSolutions = validSolutions;
        statusEl.innerText = `æ‰¾åˆ° ${totalFound} ä¸ªæ–¹æ¡ˆ (ä»…æ˜¾ç¤ºå‰ ${validSolutions.length} ä¸ª)`;
        
        validSolutions.forEach((sol, idx) => {
            renderSolution(sol, idx + 1, W, H);
        });
    }

    function openZoom(idx) {
        currentZoomIdx = idx;
        const sol = currentRenderedSolutions[idx];
        if (!sol) return;
        
        const modal = document.getElementById('zoomModal');
        const canvas = document.getElementById('zoomCanvas');
        const title = document.getElementById('zoomTitle');
        const statsContainer = document.getElementById('zoomStats');
        const W = parseFloat(document.getElementById('canvasW').value);
        const H = parseFloat(document.getElementById('canvasH').value);
        
        modal.style.display = 'flex';
        title.innerText = `æ–¹æ¡ˆ #${idx + 1} (${(sol.utilization * 100).toFixed(1)}% åˆ©ç”¨ç‡)`;
        
        if (statsContainer) {
            statsContainer.innerHTML = generateStatsHtml(sol);
        }
        
        // Calculate max dimensions for the modal canvas
        // 90vw width, 70vh height max
        const maxW = window.innerWidth * 0.9;
        const maxH = window.innerHeight * 0.7;
        
        const scaleW = maxW / W;
        const scaleH = maxH / H;
        const scale = Math.min(scaleW, scaleH); // Scale to fit
        
        const cw = W * scale;
        const ch = H * scale;
        
        canvas.width = cw;
        canvas.height = ch;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, cw, ch);
        ctx.scale(scale, scale);
        
        // Draw placements
        sol.placements.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1 / scale;
            ctx.strokeRect(p.x, p.y, p.w, p.h);
            
            // Always show text in zoom mode if reasonable size
            if (p.w * scale > 30 && p.h * scale > 15) {
                ctx.fillStyle = '#000';
                // Fix font size: use physical pixels (16px) divided by scale
                // Previous Math.max(12, ...) caused huge text when zoomed in
                const fontSize = (p.w <= 10 || p.h <= 10) ? 8 : 16;
                ctx.font = `${fontSize/scale}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
            }
        });
        
        // Draw leftovers
        if(sol.leftovers) {
            sol.leftovers.forEach(l => {
                if (l.w > 0.5 && l.h > 0.5) {
                     ctx.strokeStyle = '#888';
                     ctx.setLineDash([5/scale, 5/scale]);
                     ctx.lineWidth = 2 / scale;
                     ctx.strokeRect(l.x, l.y, l.w, l.h);
                     
                     // Show dimensions for leftovers in zoom
                     if (l.w * scale > 40 && l.h * scale > 20) {
                        ctx.fillStyle = '#666';
                        ctx.font = `${12/scale}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${l.w}x${l.h}`, l.x + l.w/2, l.y + l.h/2);
                     }
                     ctx.setLineDash([]);
                }
            });
        }
    }

    function closeZoom() {
        document.getElementById('zoomModal').style.display = 'none';
    }

    function closeDownloadModal() {
        const modal = document.getElementById('downloadModal');
        const img = document.getElementById('downloadImg');
        // Clear src to save memory
        if (img) img.src = '';
        modal.style.display = 'none';
    }

    async function downloadSolution(idx) {
        // UI Feedback: Immediate response
        const btn = document.getElementById('zoomDownloadBtn');
        const originalText = btn ? btn.innerText : "ä¿å­˜å›¾ç‰‡";
        if (btn) {
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;
            btn.style.opacity = "0.7";
        }

        // Force UI update
        await new Promise(r => setTimeout(r, 50));

        try {
            const sol = currentRenderedSolutions[idx];
            if (!sol) throw new Error("æ–¹æ¡ˆæ•°æ®ä¸¢å¤±");
            
            const W = currentFabricW;
            const H = currentFabricH;
            
            // 1. Prepare Text Data (Simplified for mobile reliability)
            const lines = [];
            lines.push({ text: `æ–¹æ¡ˆ #${idx+1}`, type: 'title' });
            lines.push({ text: `${W}x${H}cm | åˆ©ç”¨ç‡:${(sol.utilization * 100).toFixed(1)}%`, type: 'subtitle' });
            
            // Stats (Limit items to prevent huge images)
            sol.counts.forEach((c, i) => {
                if(c > 0) lines.push({ text: `${specs[i].w}x${specs[i].h}: ${c}`, type: 'item', color: specs[i].color });
            });
            
            // Leftovers
            if (sol.leftovers && sol.leftovers.length > 0) {
                const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
                if (validLeftovers.length > 0) {
                     lines.push({ text: "å‰©ä½™å¸ƒæ–™:", type: 'header' });
                     const wasteGroups = {};
                     validLeftovers.forEach(l => {
                          const key = `${l.w}x${l.h}`;
                          wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                     });
                     for (let [size, count] of Object.entries(wasteGroups)) {
                          lines.push({ text: `${size}cm: x${count}`, type: 'item-waste' });
                     }
                }
            }

            // 2. Setup Canvas Dimensions
            // NUCLEAR OPTION: Mobile Max Dimension Limit = 800px
            // This ensures it works on even the most restricted WebViews
            let PIXELS_PER_CM = 10; 
            const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window);
            
            if (isMobile) {
                const maxDimension = Math.max(W, H);
                // Force max 800px to guarantee memory safety and Base64 length safety
                if (maxDimension * PIXELS_PER_CM > 800) {
                    PIXELS_PER_CM = 800 / maxDimension; 
                }
            }
            const scale = PIXELS_PER_CM;
            
            // Layout constants
            const PADDING = 20;
            const LINE_HEIGHT = 28;
            let textSectionHeight = PADDING * 2 + lines.length * LINE_HEIGHT;
            
            const canvas = document.createElement('canvas');
            canvas.width = Math.floor(W * scale);
            canvas.height = Math.floor(H * scale + textSectionHeight);
            const ctx = canvas.getContext('2d');
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 3. Draw Layout
            ctx.save();
            ctx.scale(scale, scale);
            sol.placements.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1 / scale;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                // Simple text
                if (p.w > 5 && p.h > 5) {
                    ctx.fillStyle = '#000';
                    ctx.font = `${12/scale}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
                }
            });
            
            // Draw leftovers
            if(sol.leftovers) {
                sol.leftovers.forEach(l => {
                    if (l.w > 0.5 && l.h > 0.5) {
                         ctx.strokeStyle = '#888';
                         ctx.setLineDash([5/scale, 5/scale]);
                         ctx.lineWidth = 2 / scale;
                         ctx.strokeRect(l.x, l.y, l.w, l.h);
                         // Dimensions
                         if (l.w > 3 && l.h > 3) {
                             ctx.fillStyle = '#666';
                             ctx.font = `${12/scale}px Arial`;
                             ctx.textAlign = 'center';
                             ctx.textBaseline = 'middle';
                             ctx.fillText(`${l.w}x${l.h}`, l.x + l.w/2, l.y + l.h/2);
                         }
                         ctx.setLineDash([]);
                    }
                });
            }
            ctx.restore();
            
            // 4. Draw Info Text
            let currentY = H * scale + PADDING;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            lines.forEach(line => {
                ctx.font = line.type === 'title' ? "bold 20px Arial" : "16px Arial";
                ctx.fillStyle = '#333';
                if (line.color) {
                    ctx.fillStyle = line.color;
                    ctx.fillRect(PADDING, currentY + 4, 12, 12);
                    ctx.fillStyle = '#333';
                    ctx.fillText(line.text, PADDING + 18, currentY);
                } else {
                    ctx.fillText(line.text, PADDING, currentY);
                }
                currentY += LINE_HEIGHT;
            });
            
            // --- ROBUST AUTO DOWNLOAD STRATEGY ---
            
            // 0. HTML5+ Environment (HBuilderX / 5+App / uni-app)
            // This is the BEST way for APKs built with HBuilderX
            if (window.plus && window.plus.gallery) {
                try {
                    var bitmap = new plus.nativeObj.Bitmap("test");
                    bitmap.loadBase64Data(canvas.toDataURL('image/jpeg', 0.9), function() {
                        const fileName = "_doc/solution_" + (new Date()).getTime() + ".jpg";
                        bitmap.save(fileName, {overwrite: true}, function(i) {
                            plus.gallery.save(i.target, function() {
                                alert("å·²æˆåŠŸä¿å­˜åˆ°æ‰‹æœºç›¸å†Œï¼");
                                bitmap.clear();
                            }, function(e) {
                                alert("ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥: " + JSON.stringify(e));
                                bitmap.clear();
                            });
                        }, function(e) {
                            alert("ä¿å­˜æ–‡ä»¶å¤±è´¥: " + JSON.stringify(e));
                            bitmap.clear();
                        });
                    }, function(e) {
                        alert("å›¾ç‰‡å¤„ç†å¤±è´¥: " + JSON.stringify(e));
                    });
                    return; // Stop execution, let the native API handle it
                } catch(e) {
                    console.error("Plus API failed", e);
                }
            }

            // --- DIRECT DOWNLOAD STRATEGY (User Requested) ---
            // Bypass Share API and force direct download to local storage
            
            await new Promise((resolve, reject) => {
                canvas.toBlob(function(blob) {
                    try {
                        if (!blob) {
                            reject(new Error("å›¾ç‰‡ç”Ÿæˆå¤±è´¥"));
                            return;
                        }
                        
                        // Force "Stream" type to ensure Android WebViews treat it as a download
                        // instead of opening it in the browser/viewer.
                        const streamBlob = new Blob([blob], { type: "application/octet-stream" });
                        const url = URL.createObjectURL(streamBlob);
                        
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        link.download = `solution_${idx+1}.jpg`;
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        // Cleanup after a delay to ensure click registers
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 2000);
                        
                        resolve();
                    } catch (e) {
                        reject(e);
                    }
                }, 'image/jpeg', 0.8);
            });

            // Fallback for APKs that block blob downloads: Show image for long-press
            // Only runs if the above click() didn't trigger a page navigation/download catch
            if (isMobile) {
                 setTimeout(() => {
                      const fallbackDiv = document.createElement('div');
                      fallbackDiv.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; font-size:12px; z-index:9999; pointer-events:none; opacity:0; transition:opacity 0.5s;';
                      fallbackDiv.innerText = "å¦‚æœæœªå¼€å§‹ä¸‹è½½ï¼Œè¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜";
                      document.body.appendChild(fallbackDiv);
                      
                      // Check if we should show fallback
                      // Since we can't detect if download started, we show a non-intrusive toast
                      // AND we open the image in a way that allows long-press if the download failed silently
                      
                      // Re-enable image interaction for long press backup
                      const zoomImg = document.querySelector('#zoomModal img');
                      if(zoomImg) {
                          zoomImg.src = canvas.toDataURL('image/jpeg', 0.8); // Replace preview with full res for saving
                          requestAnimationFrame(() => {
                               fallbackDiv.style.opacity = '1';
                               setTimeout(() => fallbackDiv.remove(), 4000);
                          });
                      }
                 }, 1000);
            }

        } catch (e) {
            alert("æ“ä½œå¤±è´¥: " + e.message + "\nå»ºè®®æˆªå›¾ä¿å­˜");
        } finally {
            if (btn) {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    }

    // Guillotine Packing Algorithm
    function packItems(binW, binH, items, sortFn, splitVertical) {
        // Sort items using provided strategy or default
        let rects = items.map(i => ({...i}));
        if (sortFn) {
            rects.sort(sortFn);
        } else {
            rects.sort((a, b) => Math.max(b.w, b.h) - Math.max(a.w, a.h)); 
        }

        let root = { x: 0, y: 0, w: binW, h: binH, used: false };
        let placements = [];
        
        for (let r of rects) {
            // Try to find best fit for normal and rotated orientation
            // Strategy: Best Short Side Fit (BSSF) - minimizes the shorter leftover side
            let fit = findBestFit(root, r.w, r.h);
            let fitR = findBestFit(root, r.h, r.w);
            
            let bestNode = null;
            let rotated = false;
            
            if (fit.node && fitR.node) {
                if (fit.score <= fitR.score) {
                    bestNode = fit.node;
                } else {
                    bestNode = fitR.node;
                    rotated = true;
                }
            } else if (fit.node) {
                bestNode = fit.node;
            } else if (fitR.node) {
                bestNode = fitR.node;
                rotated = true;
            }
            
            if (bestNode) {
                let w = rotated ? r.h : r.w;
                let h = rotated ? r.w : r.h;
                splitNode(bestNode, w, h, splitVertical);
                placements.push({ x: bestNode.x, y: bestNode.y, w, h, color: r.color, id: r.id });
            } else {
                return null; 
            }
        }
        
        let leftovers = [];
        collectLeftovers(root, leftovers);
        return { placements, leftovers };
    }

    function findBestFit(root, w, h) {
        let bestNode = null;
        let bestScore = Infinity; // Lower is better (min short side remainder)

        function traverse(node) {
            if (node.used) {
                traverse(node.right);
                traverse(node.down);
            } else if (w <= node.w && h <= node.h) {
                // BSSF: Best Short Side Fit
                let remW = node.w - w;
                let remH = node.h - h;
                let score = Math.min(remW, remH);
                
                if (score < bestScore) {
                    bestScore = score;
                    bestNode = node;
                }
            }
        }
        traverse(root);
        return { node: bestNode, score: bestScore };
    }

    function splitNode(node, w, h, splitVertical) {
        node.used = true;
        if (splitVertical) {
            // Vertical Split: Cut strip of width w
            node.down = { x: node.x, y: node.y + h, w: w, h: node.h - h, used: false };
            node.right = { x: node.x + w, y: node.y, w: node.w - w, h: node.h, used: false };
        } else {
            // Horizontal Split (Default): Cut strip of height h
            node.down = { x: node.x, y: node.y + h, w: node.w, h: node.h - h, used: false };
            node.right = { x: node.x + w, y: node.y, w: node.w - w, h: h, used: false };
        }
    }
    
    function collectLeftovers(node, list) {
        if (!node) return;
        if (!node.used) {
            if (node.w > 0 && node.h > 0) list.push({x: node.x, y: node.y, w: node.w, h: node.h});
        } else {
            collectLeftovers(node.right, list);
            collectLeftovers(node.down, list);
        }
    }

    function generateStatsHtml(sol) {
        let statsHtml = '';
        sol.counts.forEach((c, i) => {
            if(c > 0) {
                statsHtml += `
                    <div class="sol-stat-row">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:${specs[i].color}; border-radius:2px;"></div>
                            ${specs[i].w}x${specs[i].h}cm
                        </span>
                        <b>x${c}</b>
                    </div>
                `;
            }
        });

        // Generate leftovers stats
        let wasteHtml = '';
        if (sol.leftovers && sol.leftovers.length > 0) {
            // Filter significant leftovers
            const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
            if (validLeftovers.length > 0) {
                // Group by size
                const wasteGroups = {};
                validLeftovers.forEach(l => {
                    const key = `${l.w}x${l.h}`;
                    wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                });
                
                wasteHtml = `<div style="margin-top:10px; font-size:12px; color:#999; border-top:1px dashed #eee; padding-top:5px;">
                    <div style="margin-bottom:2px;">å‰©ä½™å¸ƒæ–™:</div>`;
                
                for (let [size, count] of Object.entries(wasteGroups)) {
                    wasteHtml += `<div style="display:flex; justify-content:space-between;">
                        <span>${size}cm</span>
                        <span>x${count}</span>
                    </div>`;
                }
                wasteHtml += `</div>`;
            }
        }
        
        return `<div class="sol-info" style="margin-top:15px; width:100%; border-top:1px solid #eee; padding-top:10px;">
                    <div style="margin-bottom:10px; font-weight:bold; font-size:13px; color:#333;">æ•°é‡ç»Ÿè®¡</div>
                    ${statsHtml}
                    ${wasteHtml}
                </div>`;
    }

    function renderSolution(sol, idx, W, H) {
        const listEl = document.getElementById('solutionList');
        const card = document.createElement('div');
        card.className = 'solution-card';
        
        let statsHtml = '';
        sol.counts.forEach((c, i) => {
            if(c > 0) {
                statsHtml += `
                    <div class="sol-stat-row">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:${specs[i].color}; border-radius:2px;"></div>
                            ${specs[i].w}x${specs[i].h}cm
                        </span>
                        <b>x${c}</b>
                    </div>
                `;
            }
        });

        // Generate leftovers stats
        let wasteHtml = '';
        if (sol.leftovers && sol.leftovers.length > 0) {
            // Filter significant leftovers
            const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
            if (validLeftovers.length > 0) {
                // Group by size
                const wasteGroups = {};
                validLeftovers.forEach(l => {
                    const key = `${l.w}x${l.h}`;
                    wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                });
                
                wasteHtml = `<div style="margin-top:10px; font-size:12px; color:#999; border-top:1px dashed #eee; padding-top:5px;">
                    <div style="margin-bottom:2px;">å‰©ä½™å¸ƒæ–™:</div>`;
                
                for (let [size, count] of Object.entries(wasteGroups)) {
                    wasteHtml += `<div style="display:flex; justify-content:space-between;">
                        <span>${size}cm</span>
                        <span>x${count}</span>
                    </div>`;
                }
                wasteHtml += `</div>`;
            }
        }

        const scale = Math.min(200 / W, 200 / H); 
        const cw = W * scale;
        const ch = H * scale;
        const canvasId = `cvs-${Date.now()}-${idx}`;
        
        card.innerHTML = `
            <div class="sol-header">
                <span style="font-weight:bold; color:#333; white-space:nowrap;">æ–¹æ¡ˆ #${idx}</span>
                <div style="display:flex; gap:5px; align-items:center;">
                    <span class="sol-badge">${(sol.utilization * 100).toFixed(1)}% åˆ©ç”¨ç‡</span>
                </div>
            </div>
            <div class="sol-body">
                <div class="sol-canvas-wrapper" onclick="openZoom(${idx-1})" style="cursor:pointer;">
                    <canvas id="${canvasId}" width="${cw}" height="${ch}"></canvas>
                </div>
                <div class="sol-info">
                    <div style="margin-bottom:10px; font-weight:bold; font-size:13px; color:#333;">æ•°é‡ç»Ÿè®¡</div>
                    ${statsHtml}
                    ${wasteHtml}
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                         <div style="font-size:12px; color:#999;">æ€»å°ºå¯¸: ${W}x${H} cm</div>
                    </div>
                </div>
            </div>
        `;
        listEl.appendChild(card);
        
        setTimeout(() => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            ctx.scale(scale, scale);
            
            sol.placements.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1 / scale;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                
                if (p.w * scale > 20 && p.h * scale > 10) {
                    ctx.fillStyle = '#000';
                    ctx.font = `${10/scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
                }
            });
            
            if(sol.leftovers) {
                sol.leftovers.forEach(l => {
                    if (l.w > 0.5 && l.h > 0.5) {
                         ctx.strokeStyle = '#888';
                         ctx.setLineDash([3/scale, 3/scale]);
                         ctx.lineWidth = 1 / scale;
                         ctx.strokeRect(l.x, l.y, l.w, l.h);
                         
                         // Show text if space allows (threshold relaxed)
                         ctx.setLineDash([]);
                    }
                });
            }
        }, 0);
    }
</script>
</body>
</html>